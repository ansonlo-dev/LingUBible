name: Create Release and Deploy

on:
  push:
    tags:
      - 'v*'  # ç•¶æ¨é€ v* æ¨™ç±¤æ™‚è§¸ç™¼

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Get package version
      id: package_version
      run: |
        PACKAGE_VERSION=$(node -e "
        import fs from 'fs';
        const pkg = JSON.parse(fs.readFileSync('./package.json', 'utf8'));
        console.log(pkg.version);
        ")
        echo "PACKAGE_VERSION=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Package version: $PACKAGE_VERSION"
      
    - name: Determine release type
      id: release_type
      run: |
        if [[ "${{ steps.package_version.outputs.PACKAGE_VERSION }}" =~ ^0\. ]]; then
          echo "PRERELEASE=true" >> $GITHUB_OUTPUT
          echo "RELEASE_NAME=Beta ${{ steps.package_version.outputs.PACKAGE_VERSION }}" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Release type: Pre-release (Beta)"
        else
          echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          echo "RELEASE_NAME=Version ${{ steps.package_version.outputs.PACKAGE_VERSION }}" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Release type: Stable"
        fi
        
    - name: Generate changelog
      id: changelog
      run: |
        # ç°¡å–®çš„ changelog ç”Ÿæˆ
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "## ğŸš€ æ–°åŠŸèƒ½å’Œæ”¹é€²" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### âœ¨ ä¸»è¦æ›´æ–°" >> $GITHUB_OUTPUT
        echo "- ç‰ˆæœ¬æ›´æ–°è‡³ ${{ steps.package_version.outputs.PACKAGE_VERSION }}" >> $GITHUB_OUTPUT
        echo "- PWA ç‰ˆæœ¬åŒæ­¥åŠŸèƒ½" >> $GITHUB_OUTPUT
        echo "- å¤šèªè¨€ç‰ˆæœ¬å¾½ç« æ”¯æ´" >> $GITHUB_OUTPUT
        echo "- æ€§èƒ½å„ªåŒ–å’ŒéŒ¯èª¤ä¿®å¾©" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ”§ æŠ€è¡“æ”¹é€²" >> $GITHUB_OUTPUT
        echo "- è‡ªå‹•åŒ–ç‰ˆæœ¬ç®¡ç†ç³»çµ±" >> $GITHUB_OUTPUT
        echo "- GitHub API é›†æˆ" >> $GITHUB_OUTPUT
        echo "- å‹•æ…‹ PWA Manifest ç”Ÿæˆ" >> $GITHUB_OUTPUT
        echo "- ä»£ç¢¼è³ªé‡æå‡" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ“± ç”¨æˆ¶é«”é©—" >> $GITHUB_OUTPUT
        echo "- ç‰ˆæœ¬ä¿¡æ¯å¯¦æ™‚åŒæ­¥" >> $GITHUB_OUTPUT
        echo "- å¤šèªè¨€ PWA æ”¯æ´" >> $GITHUB_OUTPUT
        echo "- UI/UX å„ªåŒ–" >> $GITHUB_OUTPUT
        echo "- éŸ¿æ‡‰å¼è¨­è¨ˆæ”¹é€²" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "---" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "ğŸŒ **ç·šä¸Šé«”é©—**: [lingubible.com](https://lingubible.com)" >> $GITHUB_OUTPUT
        echo "ğŸ“š **æ–‡æª”**: [éƒ¨ç½²æŒ‡å—](https://github.com/${{ github.repository }}/tree/main/docs)" >> $GITHUB_OUTPUT
        echo "ğŸ› **å•é¡Œå›å ±**: [GitHub Issues](https://github.com/${{ github.repository }}/issues)" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Try to build project (optional)
      continue-on-error: true
      run: |
        echo "ğŸ”¨ å˜—è©¦æ§‹å»ºé …ç›®..."
        if npm run build; then
          echo "âœ… æ§‹å»ºæˆåŠŸ"
          echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "âš ï¸ æ§‹å»ºå¤±æ•—ï¼Œä½†ç¹¼çºŒå‰µå»º Release"
          echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
        fi
      env:
        VITE_APPWRITE_ENDPOINT: ${{ secrets.VITE_APPWRITE_ENDPOINT || 'https://cloud.appwrite.io/v1' }}
        VITE_APPWRITE_PROJECT_ID: ${{ secrets.VITE_APPWRITE_PROJECT_ID || 'default' }}
        VITE_APP_ENV: production
        VITE_DEV_MODE: false
        VITE_DEV_BYPASS_PASSWORD: false
        
    - name: Create build archive (if build succeeded)
      if: env.BUILD_SUCCESS == 'true'
      run: |
        echo "ğŸ“¦ å‰µå»ºæ§‹å»ºæª”æ¡ˆ..."
        cd dist
        zip -r ../lingubible-${{ steps.package_version.outputs.PACKAGE_VERSION }}-build.zip .
        cd ..
        echo "âœ… æ§‹å»ºæª”æ¡ˆå·²å‰µå»º"
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: ${{ steps.release_type.outputs.RELEASE_NAME }}
        body: ${{ steps.changelog.outputs.CHANGELOG }}
        draft: false
        prerelease: ${{ steps.release_type.outputs.PRERELEASE }}
        files: |
          lingubible-${{ steps.package_version.outputs.PACKAGE_VERSION }}-build.zip
        fail_on_unmatched_files: false
        
    - name: Release created successfully
      run: |
        echo "ğŸ‰ GitHub Release å‰µå»ºæˆåŠŸï¼"
        echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.package_version.outputs.PACKAGE_VERSION }}"
        echo "ğŸ·ï¸ æ¨™ç±¤: ${{ steps.get_version.outputs.VERSION }}"
        echo "ğŸ“‹ åç¨±: ${{ steps.release_type.outputs.RELEASE_NAME }}"
        echo "ğŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.VERSION }}" 