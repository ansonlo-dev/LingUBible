<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA 版本同步測試</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .version-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #3b82f6;
        }
        .success {
            background-color: #dcfce7;
            color: #166534;
            border-left-color: #16a34a;
        }
        .error {
            background-color: #fecaca;
            color: #dc2626;
            border-left-color: #dc2626;
        }
        .warning {
            background-color: #fef3c7;
            color: #d97706;
            border-left-color: #f59e0b;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .language-selector {
            margin: 10px 0;
        }
        .language-selector button {
            background: #6b7280;
        }
        .language-selector button.active {
            background: #1d4ed8;
        }
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>🔄 PWA 版本同步測試</h1>
    
    <div class="test-container">
        <h2>語言切換</h2>
        <div class="language-selector">
            <button onclick="setLanguage('en')" id="btn-en">English</button>
            <button onclick="setLanguage('zh-TW')" id="btn-zh-tw" class="active">繁體中文</button>
            <button onclick="setLanguage('zh-CN')" id="btn-zh-cn">简体中文</button>
        </div>
    </div>

    <div class="test-container">
        <h2>版本信息測試</h2>
        <div class="status-grid">
            <div>
                <h3>📦 本地版本 API</h3>
                <div id="local-version-info" class="version-info">載入中...</div>
                <button onclick="testLocalVersion()">測試本地版本 API</button>
            </div>
            
            <div>
                <h3>🌐 GitHub 版本 API</h3>
                <div id="github-version-info" class="version-info">載入中...</div>
                <button onclick="testGitHubVersion()">測試 GitHub 版本 API</button>
            </div>
        </div>
    </div>

    <div class="test-container">
        <h2>PWA Manifest 測試</h2>
        <div id="manifest-info" class="version-info">載入中...</div>
        <div style="margin: 15px 0;">
            <button onclick="testManifest()">測試 PWA Manifest</button>
            <button onclick="updateManifest()">更新 Manifest</button>
            <button onclick="downloadManifest()">下載 Manifest</button>
        </div>
    </div>

    <div class="test-container">
        <h2>版本同步狀態</h2>
        <div id="sync-status" class="version-info">點擊下方按鈕開始測試</div>
        <button onclick="testVersionSync()">測試版本同步</button>
        <button onclick="compareVersions()">比較所有版本</button>
    </div>

    <div class="test-container">
        <h2>詳細日誌</h2>
        <button onclick="clearLogs()">清除日誌</button>
        <pre id="logs"></pre>
    </div>

    <!-- 載入 manifest.js -->
    <script src="/manifest.js"></script>
    
    <script>
        let currentLanguage = 'zh-TW';
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logs.push(logEntry);
            console.log(logEntry);
            updateLogsDisplay();
        }

        function updateLogsDisplay() {
            document.getElementById('logs').textContent = logs.slice(-20).join('\n');
        }

        function clearLogs() {
            logs = [];
            updateLogsDisplay();
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            
            // 更新按鈕狀態
            document.querySelectorAll('.language-selector button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${lang.toLowerCase()}`).classList.add('active');
            
            // 設置 cookie
            document.cookie = `language=${lang}; path=/; max-age=31536000`;
            
            log(`語言切換到: ${lang}`);
            
            // 自動更新 manifest
            updateManifest();
        }

        async function testLocalVersion() {
            try {
                log('測試本地版本 API...');
                const response = await fetch('/api/version.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                document.getElementById('local-version-info').innerHTML = `
                    <div class="success">
                        <strong>✅ 本地版本 API 正常</strong><br>
                        版本: ${data.version}<br>
                        名稱: ${data.name}<br>
                        描述: ${data.description}<br>
                        構建時間: ${new Date(data.buildTime).toLocaleString()}<br>
                        環境: ${data.environment}
                    </div>
                `;
                
                log(`本地版本 API 成功: ${data.version}`);
                return data;
                
            } catch (error) {
                log(`本地版本 API 失敗: ${error.message}`, 'error');
                document.getElementById('local-version-info').innerHTML = `
                    <div class="error">
                        <strong>❌ 本地版本 API 失敗</strong><br>
                        錯誤: ${error.message}
                    </div>
                `;
                return null;
            }
        }

        async function testGitHubVersion() {
            try {
                log('測試 GitHub 版本 API...');
                const response = await fetch('https://api.github.com/repos/ansonlo-dev/LingUBible/releases/latest');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                document.getElementById('github-version-info').innerHTML = `
                    <div class="success">
                        <strong>✅ GitHub 版本 API 正常</strong><br>
                        標籤: ${data.tag_name}<br>
                        名稱: ${data.name}<br>
                        發布時間: ${new Date(data.published_at).toLocaleString()}<br>
                        URL: <a href="${data.html_url}" target="_blank">查看發布</a>
                    </div>
                `;
                
                log(`GitHub 版本 API 成功: ${data.tag_name}`);
                return data;
                
            } catch (error) {
                log(`GitHub 版本 API 失敗: ${error.message}`, 'error');
                document.getElementById('github-version-info').innerHTML = `
                    <div class="error">
                        <strong>❌ GitHub 版本 API 失敗</strong><br>
                        錯誤: ${error.message}
                    </div>
                `;
                return null;
            }
        }

        async function testManifest() {
            try {
                log('測試 PWA Manifest...');
                
                if (!window.LingUBibleManifest) {
                    throw new Error('LingUBibleManifest 未載入');
                }
                
                const manifest = await window.LingUBibleManifest.generateManifest(currentLanguage);
                
                document.getElementById('manifest-info').innerHTML = `
                    <div class="success">
                        <strong>✅ PWA Manifest 生成成功</strong><br>
                        名稱: ${manifest.name}<br>
                        短名稱: ${manifest.short_name}<br>
                        描述: ${manifest.description}<br>
                        版本: ${manifest.version || '未設置'}<br>
                        版本名稱: ${manifest.version_name || '未設置'}<br>
                        語言: ${manifest.lang}
                    </div>
                `;
                
                log(`PWA Manifest 生成成功: ${manifest.name}`);
                return manifest;
                
            } catch (error) {
                log(`PWA Manifest 測試失敗: ${error.message}`, 'error');
                document.getElementById('manifest-info').innerHTML = `
                    <div class="error">
                        <strong>❌ PWA Manifest 測試失敗</strong><br>
                        錯誤: ${error.message}
                    </div>
                `;
                return null;
            }
        }

        async function updateManifest() {
            try {
                log('更新 PWA Manifest...');
                
                if (window.LingUBibleManifest && window.LingUBibleManifest.updateManifestLink) {
                    await window.LingUBibleManifest.updateManifestLink();
                    log('PWA Manifest 已更新');
                    
                    // 重新測試 manifest
                    setTimeout(() => testManifest(), 500);
                } else {
                    throw new Error('updateManifestLink 函數不可用');
                }
                
            } catch (error) {
                log(`更新 PWA Manifest 失敗: ${error.message}`, 'error');
            }
        }

        async function downloadManifest() {
            try {
                const manifest = await window.LingUBibleManifest.generateManifest(currentLanguage);
                const blob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `manifest-${currentLanguage}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                log('Manifest 已下載');
                
            } catch (error) {
                log(`下載 Manifest 失敗: ${error.message}`, 'error');
            }
        }

        async function testVersionSync() {
            log('開始版本同步測試...');
            
            const localVersion = await testLocalVersion();
            const githubVersion = await testGitHubVersion();
            const manifest = await testManifest();
            
            let syncStatus = '';
            let statusClass = 'success';
            
            if (localVersion && githubVersion && manifest) {
                const localVer = localVersion.version;
                const githubVer = githubVersion.tag_name.replace(/^v/, '');
                const manifestVer = manifest.version;
                
                if (localVer === githubVer && localVer === manifestVer) {
                    syncStatus = `✅ 版本完全同步！所有版本都是 ${localVer}`;
                } else {
                    statusClass = 'warning';
                    syncStatus = `⚠️ 版本不同步！<br>
                        本地: ${localVer}<br>
                        GitHub: ${githubVer}<br>
                        PWA: ${manifestVer || '未設置'}`;
                }
            } else {
                statusClass = 'error';
                syncStatus = '❌ 無法獲取完整版本信息';
            }
            
            document.getElementById('sync-status').innerHTML = `
                <div class="${statusClass}">
                    <strong>版本同步狀態</strong><br>
                    ${syncStatus}
                </div>
            `;
            
            log('版本同步測試完成');
        }

        async function compareVersions() {
            log('比較所有版本源...');
            
            const sources = [
                { name: '本地 API', test: testLocalVersion },
                { name: 'GitHub API', test: testGitHubVersion },
                { name: 'PWA Manifest', test: testManifest }
            ];
            
            const results = [];
            
            for (const source of sources) {
                try {
                    const result = await source.test();
                    results.push({
                        name: source.name,
                        success: true,
                        version: result?.version || result?.tag_name?.replace(/^v/, '') || 'N/A',
                        data: result
                    });
                } catch (error) {
                    results.push({
                        name: source.name,
                        success: false,
                        error: error.message
                    });
                }
            }
            
            log('版本比較結果:');
            results.forEach(result => {
                if (result.success) {
                    log(`  ${result.name}: ${result.version}`);
                } else {
                    log(`  ${result.name}: 失敗 - ${result.error}`, 'error');
                }
            });
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            log('頁面載入完成，開始初始化測試...');
            
            // 自動測試所有功能
            setTimeout(() => {
                testLocalVersion();
                testGitHubVersion();
                testManifest();
            }, 1000);
        });

        // 監聽 manifest 更新事件
        window.addEventListener('manifestUpdated', (event) => {
            log(`收到 manifest 更新事件: ${event.detail.language}`);
        });
    </script>
</body>
</html> 