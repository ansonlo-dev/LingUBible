<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA ç‰ˆæœ¬åŒæ­¥æ¸¬è©¦</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .version-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #3b82f6;
        }
        .success {
            background-color: #dcfce7;
            color: #166534;
            border-left-color: #16a34a;
        }
        .error {
            background-color: #fecaca;
            color: #dc2626;
            border-left-color: #dc2626;
        }
        .warning {
            background-color: #fef3c7;
            color: #d97706;
            border-left-color: #f59e0b;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .language-selector {
            margin: 10px 0;
        }
        .language-selector button {
            background: #6b7280;
        }
        .language-selector button.active {
            background: #1d4ed8;
        }
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ”„ PWA ç‰ˆæœ¬åŒæ­¥æ¸¬è©¦</h1>
    
    <div class="test-container">
        <h2>èªè¨€åˆ‡æ›</h2>
        <div class="language-selector">
            <button onclick="setLanguage('en')" id="btn-en">English</button>
            <button onclick="setLanguage('zh-TW')" id="btn-zh-tw" class="active">ç¹é«”ä¸­æ–‡</button>
            <button onclick="setLanguage('zh-CN')" id="btn-zh-cn">ç®€ä½“ä¸­æ–‡</button>
        </div>
    </div>

    <div class="test-container">
        <h2>ç‰ˆæœ¬ä¿¡æ¯æ¸¬è©¦</h2>
        <div class="status-grid">
            <div>
                <h3>ğŸ“¦ æœ¬åœ°ç‰ˆæœ¬ API</h3>
                <div id="local-version-info" class="version-info">è¼‰å…¥ä¸­...</div>
                <button onclick="testLocalVersion()">æ¸¬è©¦æœ¬åœ°ç‰ˆæœ¬ API</button>
            </div>
            
            <div>
                <h3>ğŸŒ GitHub ç‰ˆæœ¬ API</h3>
                <div id="github-version-info" class="version-info">è¼‰å…¥ä¸­...</div>
                <button onclick="testGitHubVersion()">æ¸¬è©¦ GitHub ç‰ˆæœ¬ API</button>
            </div>
        </div>
    </div>

    <div class="test-container">
        <h2>PWA Manifest æ¸¬è©¦</h2>
        <div id="manifest-info" class="version-info">è¼‰å…¥ä¸­...</div>
        <div style="margin: 15px 0;">
            <button onclick="testManifest()">æ¸¬è©¦ PWA Manifest</button>
            <button onclick="updateManifest()">æ›´æ–° Manifest</button>
            <button onclick="downloadManifest()">ä¸‹è¼‰ Manifest</button>
        </div>
    </div>

    <div class="test-container">
        <h2>ç‰ˆæœ¬åŒæ­¥ç‹€æ…‹</h2>
        <div id="sync-status" class="version-info">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦</div>
        <button onclick="testVersionSync()">æ¸¬è©¦ç‰ˆæœ¬åŒæ­¥</button>
        <button onclick="compareVersions()">æ¯”è¼ƒæ‰€æœ‰ç‰ˆæœ¬</button>
    </div>

    <div class="test-container">
        <h2>è©³ç´°æ—¥èªŒ</h2>
        <button onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
        <pre id="logs"></pre>
    </div>

    <!-- è¼‰å…¥ manifest.js -->
    <script src="/manifest.js"></script>
    
    <script>
        let currentLanguage = 'zh-TW';
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logs.push(logEntry);
            console.log(logEntry);
            updateLogsDisplay();
        }

        function updateLogsDisplay() {
            document.getElementById('logs').textContent = logs.slice(-20).join('\n');
        }

        function clearLogs() {
            logs = [];
            updateLogsDisplay();
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.language-selector button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${lang.toLowerCase()}`).classList.add('active');
            
            // è¨­ç½® cookie
            document.cookie = `language=${lang}; path=/; max-age=31536000`;
            
            log(`èªè¨€åˆ‡æ›åˆ°: ${lang}`);
            
            // è‡ªå‹•æ›´æ–° manifest
            updateManifest();
        }

        async function testLocalVersion() {
            try {
                log('æ¸¬è©¦æœ¬åœ°ç‰ˆæœ¬ API...');
                const response = await fetch('/api/version.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                document.getElementById('local-version-info').innerHTML = `
                    <div class="success">
                        <strong>âœ… æœ¬åœ°ç‰ˆæœ¬ API æ­£å¸¸</strong><br>
                        ç‰ˆæœ¬: ${data.version}<br>
                        åç¨±: ${data.name}<br>
                        æè¿°: ${data.description}<br>
                        æ§‹å»ºæ™‚é–“: ${new Date(data.buildTime).toLocaleString()}<br>
                        ç’°å¢ƒ: ${data.environment}
                    </div>
                `;
                
                log(`æœ¬åœ°ç‰ˆæœ¬ API æˆåŠŸ: ${data.version}`);
                return data;
                
            } catch (error) {
                log(`æœ¬åœ°ç‰ˆæœ¬ API å¤±æ•—: ${error.message}`, 'error');
                document.getElementById('local-version-info').innerHTML = `
                    <div class="error">
                        <strong>âŒ æœ¬åœ°ç‰ˆæœ¬ API å¤±æ•—</strong><br>
                        éŒ¯èª¤: ${error.message}
                    </div>
                `;
                return null;
            }
        }

        async function testGitHubVersion() {
            try {
                log('æ¸¬è©¦ GitHub ç‰ˆæœ¬ API...');
                const response = await fetch('https://api.github.com/repos/ansonlo-dev/LingUBible/releases/latest');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                document.getElementById('github-version-info').innerHTML = `
                    <div class="success">
                        <strong>âœ… GitHub ç‰ˆæœ¬ API æ­£å¸¸</strong><br>
                        æ¨™ç±¤: ${data.tag_name}<br>
                        åç¨±: ${data.name}<br>
                        ç™¼å¸ƒæ™‚é–“: ${new Date(data.published_at).toLocaleString()}<br>
                        URL: <a href="${data.html_url}" target="_blank">æŸ¥çœ‹ç™¼å¸ƒ</a>
                    </div>
                `;
                
                log(`GitHub ç‰ˆæœ¬ API æˆåŠŸ: ${data.tag_name}`);
                return data;
                
            } catch (error) {
                log(`GitHub ç‰ˆæœ¬ API å¤±æ•—: ${error.message}`, 'error');
                document.getElementById('github-version-info').innerHTML = `
                    <div class="error">
                        <strong>âŒ GitHub ç‰ˆæœ¬ API å¤±æ•—</strong><br>
                        éŒ¯èª¤: ${error.message}
                    </div>
                `;
                return null;
            }
        }

        async function testManifest() {
            try {
                log('æ¸¬è©¦ PWA Manifest...');
                
                if (!window.LingUBibleManifest) {
                    throw new Error('LingUBibleManifest æœªè¼‰å…¥');
                }
                
                const manifest = await window.LingUBibleManifest.generateManifest(currentLanguage);
                
                document.getElementById('manifest-info').innerHTML = `
                    <div class="success">
                        <strong>âœ… PWA Manifest ç”ŸæˆæˆåŠŸ</strong><br>
                        åç¨±: ${manifest.name}<br>
                        çŸ­åç¨±: ${manifest.short_name}<br>
                        æè¿°: ${manifest.description}<br>
                        ç‰ˆæœ¬: ${manifest.version || 'æœªè¨­ç½®'}<br>
                        ç‰ˆæœ¬åç¨±: ${manifest.version_name || 'æœªè¨­ç½®'}<br>
                        èªè¨€: ${manifest.lang}
                    </div>
                `;
                
                log(`PWA Manifest ç”ŸæˆæˆåŠŸ: ${manifest.name}`);
                return manifest;
                
            } catch (error) {
                log(`PWA Manifest æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                document.getElementById('manifest-info').innerHTML = `
                    <div class="error">
                        <strong>âŒ PWA Manifest æ¸¬è©¦å¤±æ•—</strong><br>
                        éŒ¯èª¤: ${error.message}
                    </div>
                `;
                return null;
            }
        }

        async function updateManifest() {
            try {
                log('æ›´æ–° PWA Manifest...');
                
                if (window.LingUBibleManifest && window.LingUBibleManifest.updateManifestLink) {
                    await window.LingUBibleManifest.updateManifestLink();
                    log('PWA Manifest å·²æ›´æ–°');
                    
                    // é‡æ–°æ¸¬è©¦ manifest
                    setTimeout(() => testManifest(), 500);
                } else {
                    throw new Error('updateManifestLink å‡½æ•¸ä¸å¯ç”¨');
                }
                
            } catch (error) {
                log(`æ›´æ–° PWA Manifest å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function downloadManifest() {
            try {
                const manifest = await window.LingUBibleManifest.generateManifest(currentLanguage);
                const blob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `manifest-${currentLanguage}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                log('Manifest å·²ä¸‹è¼‰');
                
            } catch (error) {
                log(`ä¸‹è¼‰ Manifest å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testVersionSync() {
            log('é–‹å§‹ç‰ˆæœ¬åŒæ­¥æ¸¬è©¦...');
            
            const localVersion = await testLocalVersion();
            const githubVersion = await testGitHubVersion();
            const manifest = await testManifest();
            
            let syncStatus = '';
            let statusClass = 'success';
            
            if (localVersion && githubVersion && manifest) {
                const localVer = localVersion.version;
                const githubVer = githubVersion.tag_name.replace(/^v/, '');
                const manifestVer = manifest.version;
                
                if (localVer === githubVer && localVer === manifestVer) {
                    syncStatus = `âœ… ç‰ˆæœ¬å®Œå…¨åŒæ­¥ï¼æ‰€æœ‰ç‰ˆæœ¬éƒ½æ˜¯ ${localVer}`;
                } else {
                    statusClass = 'warning';
                    syncStatus = `âš ï¸ ç‰ˆæœ¬ä¸åŒæ­¥ï¼<br>
                        æœ¬åœ°: ${localVer}<br>
                        GitHub: ${githubVer}<br>
                        PWA: ${manifestVer || 'æœªè¨­ç½®'}`;
                }
            } else {
                statusClass = 'error';
                syncStatus = 'âŒ ç„¡æ³•ç²å–å®Œæ•´ç‰ˆæœ¬ä¿¡æ¯';
            }
            
            document.getElementById('sync-status').innerHTML = `
                <div class="${statusClass}">
                    <strong>ç‰ˆæœ¬åŒæ­¥ç‹€æ…‹</strong><br>
                    ${syncStatus}
                </div>
            `;
            
            log('ç‰ˆæœ¬åŒæ­¥æ¸¬è©¦å®Œæˆ');
        }

        async function compareVersions() {
            log('æ¯”è¼ƒæ‰€æœ‰ç‰ˆæœ¬æº...');
            
            const sources = [
                { name: 'æœ¬åœ° API', test: testLocalVersion },
                { name: 'GitHub API', test: testGitHubVersion },
                { name: 'PWA Manifest', test: testManifest }
            ];
            
            const results = [];
            
            for (const source of sources) {
                try {
                    const result = await source.test();
                    results.push({
                        name: source.name,
                        success: true,
                        version: result?.version || result?.tag_name?.replace(/^v/, '') || 'N/A',
                        data: result
                    });
                } catch (error) {
                    results.push({
                        name: source.name,
                        success: false,
                        error: error.message
                    });
                }
            }
            
            log('ç‰ˆæœ¬æ¯”è¼ƒçµæœ:');
            results.forEach(result => {
                if (result.success) {
                    log(`  ${result.name}: ${result.version}`);
                } else {
                    log(`  ${result.name}: å¤±æ•— - ${result.error}`, 'error');
                }
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–æ¸¬è©¦...');
            
            // è‡ªå‹•æ¸¬è©¦æ‰€æœ‰åŠŸèƒ½
            setTimeout(() => {
                testLocalVersion();
                testGitHubVersion();
                testManifest();
            }, 1000);
        });

        // ç›£è½ manifest æ›´æ–°äº‹ä»¶
        window.addEventListener('manifestUpdated', (event) => {
            log(`æ”¶åˆ° manifest æ›´æ–°äº‹ä»¶: ${event.detail.language}`);
        });
    </script>
</body>
</html> 