<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡Œé¢ PWA å®‰è£è¨ºæ–·å·¥å…· - LingUBible</title>
    <link rel="manifest" href="/manifest-dynamic.json" id="manifest-link">
    <meta name="theme-color" content="#dc2626">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: rgba(76, 175, 80, 0.3); border-left: 4px solid #4CAF50; }
        .status.error { background: rgba(244, 67, 54, 0.3); border-left: 4px solid #f44336; }
        .status.warning { background: rgba(255, 193, 7, 0.3); border-left: 4px solid #ffc107; }
        .status.info { background: rgba(33, 150, 243, 0.3); border-left: 4px solid #2196f3; }
        
        button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .install-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            font-size: 18px;
            padding: 20px 40px;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .metric-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .browser-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        .install-instructions {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¥ï¸ æ¡Œé¢ PWA å®‰è£è¨ºæ–·å·¥å…·</h1>
        
        <div class="section">
            <h2>ğŸ“Š å³æ™‚ç‹€æ…‹</h2>
            <div class="grid">
                <div class="metric">
                    <div class="metric-value" id="install-available">âŒ</div>
                    <div class="metric-label">å®‰è£æç¤ºå¯ç”¨</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="sw-status">âŒ</div>
                    <div class="metric-label">Service Worker</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="manifest-status">âŒ</div>
                    <div class="metric-label">Manifest æ–‡ä»¶</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="https-status">âŒ</div>
                    <div class="metric-label">HTTPS é€£æ¥</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸš€ å®‰è£æ¸¬è©¦</h2>
            <button id="install-btn" class="install-btn" disabled>ç­‰å¾…å®‰è£æç¤º...</button>
            <button onclick="runFullDiagnostics()">ğŸ” å®Œæ•´è¨ºæ–·</button>
            <button onclick="testManifest()">ğŸ“„ æ¸¬è©¦ Manifest</button>
            <button onclick="checkIcons()">ğŸ–¼ï¸ æª¢æŸ¥åœ–æ¨™</button>
            <button onclick="showBrowserInstructions()">ğŸ“– ç€è¦½å™¨æŒ‡å¼•</button>
        </div>

        <div class="section">
            <h2>ğŸ“‹ è¨ºæ–·çµæœ</h2>
            <div id="results"></div>
        </div>

        <div class="section">
            <h2>ğŸŒ ç€è¦½å™¨ä¿¡æ¯</h2>
            <div class="browser-info" id="browser-info"></div>
        </div>

        <div class="section">
            <h2>ğŸ“ å³æ™‚æ—¥èªŒ</h2>
            <div class="log" id="log"></div>
        </div>

        <div id="install-instructions" class="install-instructions hidden">
            <h3>ğŸ“– æ‰‹å‹•å®‰è£æŒ‡å¼•</h3>
            <p id="instructions-text"></p>
        </div>
    </div>

    <script>
        let deferredPrompt;
        const results = document.getElementById('results');
        const log = document.getElementById('log');
        const installBtn = document.getElementById('install-btn');
        const browserInfo = document.getElementById('browser-info');

        // æ—¥èªŒå‡½æ•¸
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        // çµæœå‡½æ•¸
        function addResult(type, message) {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            results.appendChild(div);
        }

        // æ›´æ–°ç‹€æ…‹æŒ‡æ¨™
        function updateStatus(id, status, value = null) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = status ? 'âœ…' : 'âŒ';
                if (value) element.textContent = value;
            }
        }

        // ç›£è½ PWA äº‹ä»¶
        window.addEventListener('beforeinstallprompt', (e) => {
            addLog('ğŸ’¡ æ”¶åˆ° beforeinstallprompt äº‹ä»¶');
            addLog(`ğŸ–¥ï¸ æ”¯æ´çš„å¹³å°: ${e.platforms.join(', ')}`);
            
            e.preventDefault();
            deferredPrompt = e;
            
            updateStatus('install-available', true);
            installBtn.disabled = false;
            installBtn.textContent = 'ğŸš€ å®‰è£ PWA';
            
            addResult('success', 'âœ… PWA å®‰è£æç¤ºå¯ç”¨ï¼ç€è¦½å™¨æ‡‰è©²é¡¯ç¤ºå®‰è£åœ–æ¨™ã€‚');
        });

        window.addEventListener('appinstalled', () => {
            addLog('ğŸ‰ PWA å®‰è£æˆåŠŸ');
            addResult('success', 'ğŸ‰ PWA å®‰è£æˆåŠŸï¼');
            installBtn.style.display = 'none';
            updateStatus('install-available', false, 'å·²å®‰è£');
        });

        // å®‰è£æŒ‰éˆ•äº‹ä»¶
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                addLog('ğŸš€ è§¸ç™¼å®‰è£æç¤º');
                try {
                    await deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    addLog(`ğŸ‘¤ ç”¨æˆ¶é¸æ“‡: ${outcome}`);
                    addResult('info', `ç”¨æˆ¶é¸æ“‡: ${outcome}`);
                    deferredPrompt = null;
                    if (outcome === 'dismissed') {
                        installBtn.textContent = 'ç”¨æˆ¶å–æ¶ˆå®‰è£';
                        installBtn.disabled = true;
                    }
                } catch (error) {
                    addLog(`âŒ å®‰è£éŒ¯èª¤: ${error.message}`);
                    addResult('error', `å®‰è£éŒ¯èª¤: ${error.message}`);
                }
            } else {
                showBrowserInstructions();
            }
        });

        // å®Œæ•´è¨ºæ–·
        async function runFullDiagnostics() {
            results.innerHTML = '';
            addLog('ğŸ” é–‹å§‹å®Œæ•´è¨ºæ–·...');
            
            // 1. æª¢æŸ¥ HTTPS
            const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
            updateStatus('https-status', isHTTPS);
            addResult(isHTTPS ? 'success' : 'error', 
                     isHTTPS ? 'âœ… HTTPS é€£æ¥æ­£å¸¸' : 'âŒ éœ€è¦ HTTPS é€£æ¥');

            // 2. æª¢æŸ¥ Service Worker
            const hasSW = 'serviceWorker' in navigator;
            updateStatus('sw-status', hasSW);
            addResult(hasSW ? 'success' : 'error', 
                     hasSW ? 'âœ… ç€è¦½å™¨æ”¯æ´ Service Worker' : 'âŒ ç€è¦½å™¨ä¸æ”¯æ´ Service Worker');

            if (hasSW) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        addResult('success', `âœ… Service Worker å·²è¨»å†Š: ${registration.scope}`);
                        addLog(`ğŸ“„ SW ç‹€æ…‹: ${registration.active ? 'æ´»èº' : 'æœªæ´»èº'}`);
                    } else {
                        addResult('warning', 'âš ï¸ Service Worker æœªè¨»å†Š');
                    }
                } catch (error) {
                    addResult('error', `âŒ Service Worker æª¢æŸ¥å¤±æ•—: ${error.message}`);
                }
            }

            // 3. æª¢æŸ¥ Manifest
            await testManifest();

            // 4. æª¢æŸ¥åœ–æ¨™
            await checkIcons();

            // 5. æª¢æŸ¥ PWA æ¢ä»¶
            checkPWAConditions();

            addLog('âœ… è¨ºæ–·å®Œæˆ');
        }

        // æ¸¬è©¦ Manifest
        async function testManifest() {
            try {
                addLog('ğŸ“„ æ¸¬è©¦ Manifest æ–‡ä»¶...');
                const response = await fetch('/manifest-dynamic.json?v=' + Date.now());
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const manifest = await response.json();
                updateStatus('manifest-status', true);
                addResult('success', 'âœ… Manifest æ–‡ä»¶è¼‰å…¥æˆåŠŸ');
                
                // æª¢æŸ¥å¿…è¦å­—æ®µ
                const required = ['name', 'start_url', 'display', 'icons'];
                const missing = required.filter(field => !manifest[field]);
                
                if (missing.length === 0) {
                    addResult('success', 'âœ… Manifest åŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ');
                } else {
                    addResult('error', `âŒ Manifest ç¼ºå°‘å­—æ®µ: ${missing.join(', ')}`);
                }

                // æª¢æŸ¥åœ–æ¨™
                if (manifest.icons && manifest.icons.length > 0) {
                    const hasLargeIcon = manifest.icons.some(icon => 
                        icon.sizes.includes('512') || icon.sizes.includes('192')
                    );
                    if (hasLargeIcon) {
                        addResult('success', 'âœ… Manifest åŒ…å«å¤§å°ºå¯¸åœ–æ¨™');
                    } else {
                        addResult('warning', 'âš ï¸ Manifest ç¼ºå°‘å¤§å°ºå¯¸åœ–æ¨™ (192x192 æˆ– 512x512)');
                    }
                    
                    addLog(`ğŸ–¼ï¸ åœ–æ¨™æ•¸é‡: ${manifest.icons.length}`);
                    manifest.icons.forEach((icon, index) => {
                        addLog(`   ${index + 1}. ${icon.src} (${icon.sizes})`);
                    });
                } else {
                    addResult('error', 'âŒ Manifest æ²’æœ‰åœ–æ¨™');
                }

                // é¡¯ç¤º Manifest è©³æƒ…
                addLog(`ğŸ“ æ‡‰ç”¨åç¨±: ${manifest.name}`);
                addLog(`ğŸ“ ç°¡ç¨±: ${manifest.short_name}`);
                addLog(`ğŸ“ é¡¯ç¤ºæ¨¡å¼: ${manifest.display}`);
                addLog(`ğŸ“ èµ·å§‹ URL: ${manifest.start_url}`);
                
            } catch (error) {
                updateStatus('manifest-status', false);
                addResult('error', `âŒ Manifest è¼‰å…¥å¤±æ•—: ${error.message}`);
                addLog(`âŒ Manifest éŒ¯èª¤: ${error.message}`);
            }
        }

        // æª¢æŸ¥åœ–æ¨™
        async function checkIcons() {
            addLog('ğŸ–¼ï¸ æª¢æŸ¥åœ–æ¨™æ–‡ä»¶...');
            
            const iconPaths = [
                '/favicon.ico',
                '/favicon.svg',
                '/favicon-96x96.png',
                '/apple-touch-icon.png',
                '/android/android-launchericon-192-192.png',
                '/android/android-launchericon-512-512.png'
            ];

            let successCount = 0;
            
            for (const path of iconPaths) {
                try {
                    const response = await fetch(path, { method: 'HEAD' });
                    if (response.ok) {
                        addLog(`âœ… ${path} - å¯è¨ªå•`);
                        successCount++;
                    } else {
                        addLog(`âŒ ${path} - HTTP ${response.status}`);
                    }
                } catch (error) {
                    addLog(`âŒ ${path} - è¼‰å…¥å¤±æ•—`);
                }
            }
            
            const percentage = Math.round((successCount / iconPaths.length) * 100);
            addResult(percentage > 80 ? 'success' : 'warning', 
                     `ğŸ–¼ï¸ åœ–æ¨™æ–‡ä»¶å¯ç”¨æ€§: ${successCount}/${iconPaths.length} (${percentage}%)`);
        }

        // æª¢æŸ¥ PWA æ¢ä»¶
        function checkPWAConditions() {
            addLog('ğŸ” æª¢æŸ¥ PWA å®‰è£æ¢ä»¶...');
            
            const conditions = [
                {
                    name: 'HTTPS æˆ– localhost',
                    check: location.protocol === 'https:' || location.hostname === 'localhost',
                    required: true
                },
                {
                    name: 'Service Worker æ”¯æ´',
                    check: 'serviceWorker' in navigator,
                    required: true
                },
                {
                    name: 'Manifest æ–‡ä»¶',
                    check: document.querySelector('link[rel="manifest"]') !== null,
                    required: true
                },
                {
                    name: 'æœªåœ¨ PWA æ¨¡å¼',
                    check: !window.matchMedia('(display-mode: standalone)').matches,
                    required: true
                },
                {
                    name: 'æ¡Œé¢ç€è¦½å™¨',
                    check: !(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)),
                    required: false
                },
                {
                    name: 'Chrome æˆ– Edge',
                    check: /Chrome|Edg/i.test(navigator.userAgent) && !/OPR/i.test(navigator.userAgent),
                    required: false
                }
            ];

            let passedRequired = 0;
            let totalRequired = 0;
            
            conditions.forEach(condition => {
                const status = condition.check ? 'âœ…' : 'âŒ';
                const type = condition.required ? (condition.check ? 'success' : 'error') : 
                           (condition.check ? 'success' : 'warning');
                
                addResult(type, `${status} ${condition.name}${condition.required ? ' (å¿…éœ€)' : ' (å»ºè­°)'}`);
                
                if (condition.required) {
                    totalRequired++;
                    if (condition.check) passedRequired++;
                }
            });

            if (passedRequired === totalRequired) {
                addResult('success', 'ğŸ‰ æ»¿è¶³æ‰€æœ‰ PWA å®‰è£æ¢ä»¶ï¼');
            } else {
                addResult('error', `âŒ æœªæ»¿è¶³ ${totalRequired - passedRequired} å€‹å¿…éœ€æ¢ä»¶`);
            }
        }

        // é¡¯ç¤ºç€è¦½å™¨æŒ‡å¼•
        function showBrowserInstructions() {
            const userAgent = navigator.userAgent.toLowerCase();
            let instructions = '';
            
            if (userAgent.includes('chrome') && !userAgent.includes('edg')) {
                instructions = 'åœ¨ Chrome ä¸­ï¼š\n1. æŸ¥çœ‹åœ°å€æ¬„å³å´æ˜¯å¦æœ‰å®‰è£åœ–æ¨™ âŠ•\n2. æˆ–é»æ“Šå³ä¸Šè§’ä¸‰é»èœå–® â†’ ã€Œå®‰è£ LingUBible...ã€\n3. å¦‚æœæ²’æœ‰çœ‹åˆ°ï¼Œè«‹ç¢ºä¿æ»¿è¶³æ‰€æœ‰ PWA æ¢ä»¶';
            } else if (userAgent.includes('edg')) {
                instructions = 'åœ¨ Edge ä¸­ï¼š\n1. æŸ¥çœ‹åœ°å€æ¬„å³å´æ˜¯å¦æœ‰å®‰è£åœ–æ¨™ âŠ•\n2. æˆ–é»æ“Šå³ä¸Šè§’ä¸‰é»èœå–® â†’ ã€Œæ‡‰ç”¨ç¨‹å¼ã€â†’ ã€Œå°‡æ­¤ç¶²ç«™å®‰è£ç‚ºæ‡‰ç”¨ç¨‹å¼ã€\n3. å¦‚æœæ²’æœ‰çœ‹åˆ°ï¼Œè«‹ç¢ºä¿æ»¿è¶³æ‰€æœ‰ PWA æ¢ä»¶';
            } else if (userAgent.includes('firefox')) {
                instructions = 'åœ¨ Firefox ä¸­ï¼š\n1. PWA å®‰è£æ”¯æ´æœ‰é™\n2. å¯ä»¥å˜—è©¦é»æ“Šåœ°å€æ¬„çš„å®‰è£åœ–æ¨™\n3. å»ºè­°ä½¿ç”¨ Chrome æˆ– Edge ç²å¾—æ›´å¥½çš„ PWA é«”é©—';
            } else if (userAgent.includes('safari')) {
                instructions = 'åœ¨ Safari ä¸­ï¼š\n1. é»æ“Šåˆ†äº«æŒ‰éˆ• ğŸ“¤\n2. é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€\n3. æ³¨æ„ï¼šSafari çš„ PWA æ”¯æ´èˆ‡å…¶ä»–ç€è¦½å™¨ä¸åŒ';
            } else {
                instructions = 'åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼š\n1. æŸ¥çœ‹åœ°å€æ¬„æ˜¯å¦æœ‰å®‰è£åœ–æ¨™\n2. æª¢æŸ¥ç€è¦½å™¨èœå–®ä¸­çš„å®‰è£é¸é …\n3. å»ºè­°ä½¿ç”¨ Chrome æˆ– Edge ç²å¾—æœ€ä½³é«”é©—';
            }
            
            document.getElementById('instructions-text').textContent = instructions;
            document.getElementById('install-instructions').classList.remove('hidden');
            
            addLog('ğŸ“– é¡¯ç¤ºç€è¦½å™¨å®‰è£æŒ‡å¼•');
        }

        // æ›´æ–°ç€è¦½å™¨ä¿¡æ¯
        function updateBrowserInfo() {
            const info = {
                'ç”¨æˆ¶ä»£ç†': navigator.userAgent,
                'å¹³å°': navigator.platform,
                'èªè¨€': navigator.language,
                'åœ¨ç·šç‹€æ…‹': navigator.onLine ? 'åœ¨ç·š' : 'é›¢ç·š',
                'ç•¶å‰ URL': location.href,
                'å”è­°': location.protocol,
                'ä¸»æ©Ÿå': location.hostname,
                'é¡¯ç¤ºæ¨¡å¼': window.matchMedia('(display-mode: standalone)').matches ? 'PWA æ¨¡å¼' : 'ç€è¦½å™¨æ¨¡å¼',
                'è¦–çª—å¤§å°': `${window.innerWidth} x ${window.innerHeight}`,
                'è¢å¹•å¤§å°': `${screen.width} x ${screen.height}`,
                'Service Worker': 'serviceWorker' in navigator ? 'æ”¯æ´' : 'ä¸æ”¯æ´',
                'Push é€šçŸ¥': 'PushManager' in window ? 'æ”¯æ´' : 'ä¸æ”¯æ´',
                'Notification': 'Notification' in window ? 'æ”¯æ´' : 'ä¸æ”¯æ´'
            };
            
            browserInfo.innerHTML = Object.entries(info)
                .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                .join('<br>');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸš€ æ¡Œé¢ PWA è¨ºæ–·å·¥å…·å·²è¼‰å…¥');
            updateBrowserInfo();
            
            // å»¶é²é‹è¡Œè¨ºæ–·ï¼Œç­‰å¾… PWA äº‹ä»¶
            setTimeout(() => {
                if (!deferredPrompt) {
                    addLog('âš ï¸ 5ç§’å¾Œä»æœªæ”¶åˆ°å®‰è£æç¤ºï¼Œé–‹å§‹è¨ºæ–·...');
                    runFullDiagnostics();
                }
            }, 5000);
        });

        // å®šæœŸæª¢æŸ¥ç‹€æ…‹
        setInterval(() => {
            updateStatus('install-available', !!deferredPrompt);
        }, 1000);
    </script>
</body>
</html> 