<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å‡ºæ™‚åºæ¸¬è©¦ - LingUBible</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .counter {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
            border: 3px solid #007bff;
        }
        .counter.correct {
            border-color: #28a745;
            color: #28a745;
        }
        .counter.incorrect {
            border-color: #dc3545;
            color: #dc3545;
        }
        .timeline {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .timeline-item {
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .timeline-item:last-child {
            border-bottom: none;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-step {
            background: #e9ecef;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>â±ï¸ ç™»å‡ºæ™‚åºæ¸¬è©¦</h1>
        <p>é€™å€‹é é¢å°ˆé–€æ¸¬è©¦ç”¨æˆ¶ç™»å‡ºæ™‚çµ±è¨ˆè¨ˆæ•¸å™¨çš„å³æ™‚æ›´æ–°æ•ˆæœã€‚</p>
        
        <div class="status warning">
            <strong>æ¸¬è©¦ç›®æ¨™ï¼š</strong><br>
            é©—è­‰ç”¨æˆ¶ç™»å‡ºå¾Œï¼Œåœ¨ç·šç”¨æˆ¶è¨ˆæ•¸å™¨æ˜¯å¦ç«‹å³æ¸›å°‘ï¼Œè€Œä¸éœ€è¦ç­‰å¾…ä¸‹æ¬¡å®šæœŸæ›´æ–°ã€‚
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“Š åœ¨ç·šç”¨æˆ¶è¨ˆæ•¸å™¨</h3>
        <div class="counter" id="counter">0</div>
        <div style="text-align: center;">
            <button class="button" onclick="refreshCounter()">ğŸ”„ æ‰‹å‹•åˆ·æ–°</button>
            <span id="last-update">æœ€å¾Œæ›´æ–°: æœªçŸ¥</span>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ§ª æ¸¬è©¦æ§åˆ¶</h3>
        <div class="test-step">
            <strong>æ­¥é©Ÿ 1:</strong> æ¨¡æ“¬ç”¨æˆ¶ç™»å…¥
            <br><button class="button" onclick="simulateLogin()">ğŸ‘¤ æ¨¡æ“¬ç™»å…¥</button>
            <span id="login-status">ç­‰å¾…æ“ä½œ</span>
        </div>
        
        <div class="test-step">
            <strong>æ­¥é©Ÿ 2:</strong> æ¨¡æ“¬ç”¨æˆ¶ç™»å‡ºä¸¦è§€å¯Ÿè¨ˆæ•¸å™¨è®ŠåŒ–
            <br><button class="button danger" onclick="simulateLogout()">ğŸ‘‹ æ¨¡æ“¬ç™»å‡º</button>
            <span id="logout-status">ç­‰å¾…æ“ä½œ</span>
        </div>
        
        <div class="test-step">
            <strong>æ­¥é©Ÿ 3:</strong> è‡ªå‹•åŒ–æ¸¬è©¦
            <br><button class="button" onclick="runAutomatedTest()">ğŸ¤– åŸ·è¡Œè‡ªå‹•åŒ–æ¸¬è©¦</button>
            <span id="auto-test-status">ç­‰å¾…æ“ä½œ</span>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“ æ™‚åºè¨˜éŒ„</h3>
        <div class="timeline" id="timeline">
            <!-- æ™‚åºè¨˜éŒ„å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
        <button class="button" onclick="clearTimeline()">æ¸…é™¤è¨˜éŒ„</button>
    </div>

    <div class="card">
        <h3>ğŸ“ˆ æ¸¬è©¦çµæœåˆ†æ</h3>
        <div id="test-results">
            <p>åŸ·è¡Œæ¸¬è©¦å¾Œï¼Œé€™è£¡æœƒé¡¯ç¤ºè©³ç´°çš„æ™‚åºåˆ†æçµæœã€‚</p>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let testStartTime = null;
        let expectedCount = 0;

        // æ¨¡æ“¬çµ±è¨ˆæœå‹™
        class TimingTestService {
            constructor() {
                this.sessions = new Map();
                this.stats = { onlineUsers: 0 };
            }

            async login(userId) {
                const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                this.sessions.set(sessionId, {
                    userId,
                    sessionId,
                    loginTime: Date.now(),
                    lastPing: Date.now()
                });
                this.updateStats();
                logEvent(`ç”¨æˆ¶ ${userId} ç™»å…¥ï¼Œæœƒè©±: ${sessionId.substr(-8)}`);
                return sessionId;
            }

            async logout(sessionId) {
                if (this.sessions.has(sessionId)) {
                    const session = this.sessions.get(sessionId);
                    this.sessions.delete(sessionId);
                    this.updateStats();
                    logEvent(`ç”¨æˆ¶ ${session.userId} ç™»å‡ºï¼Œæœƒè©±: ${sessionId.substr(-8)}`);
                    
                    // æ¨¡æ“¬æ•¸æ“šåº«å»¶é²
                    return new Promise(resolve => {
                        setTimeout(() => {
                            logEvent(`æ•¸æ“šåº«æ“ä½œå®Œæˆ - æœƒè©± ${sessionId.substr(-8)} å·²åˆªé™¤`);
                            resolve();
                        }, Math.random() * 200 + 100); // 100-300ms å»¶é²
                    });
                } else {
                    logEvent(`å˜—è©¦ç™»å‡ºä¸å­˜åœ¨çš„æœƒè©±: ${sessionId.substr(-8)}`);
                }
            }

            updateStats() {
                this.stats.onlineUsers = this.sessions.size;
                logEvent(`çµ±è¨ˆæ›´æ–°: ${this.stats.onlineUsers} å€‹åœ¨ç·šç”¨æˆ¶`);
            }

            getStats() {
                return { ...this.stats };
            }
        }

        const testService = new TimingTestService();

        function logEvent(message) {
            const timeline = document.getElementById('timeline');
            const timestamp = new Date().toLocaleTimeString();
            const elapsed = testStartTime ? Date.now() - testStartTime : 0;
            
            const item = document.createElement('div');
            item.className = 'timeline-item';
            item.innerHTML = `[${timestamp}] (+${elapsed}ms) ${message}`;
            timeline.appendChild(item);
            timeline.scrollTop = timeline.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }

        function updateCounter() {
            const stats = testService.getStats();
            const counter = document.getElementById('counter');
            const lastUpdate = document.getElementById('last-update');
            
            counter.textContent = stats.onlineUsers;
            lastUpdate.textContent = `æœ€å¾Œæ›´æ–°: ${new Date().toLocaleTimeString()}`;
            
            // æª¢æŸ¥è¨ˆæ•¸å™¨æ˜¯å¦æ­£ç¢º
            if (stats.onlineUsers === expectedCount) {
                counter.className = 'counter correct';
            } else {
                counter.className = 'counter incorrect';
            }
            
            logEvent(`UI æ›´æ–°: é¡¯ç¤º ${stats.onlineUsers} å€‹åœ¨ç·šç”¨æˆ¶`);
        }

        function refreshCounter() {
            logEvent('æ‰‹å‹•åˆ·æ–°è¨ˆæ•¸å™¨');
            updateCounter();
        }

        async function simulateLogin() {
            const loginStatus = document.getElementById('login-status');
            testStartTime = Date.now();
            
            try {
                logEvent('=== é–‹å§‹ç™»å…¥æ¸¬è©¦ ===');
                currentSessionId = await testService.login('test_user_1');
                expectedCount = 1;
                
                // æ¨¡æ“¬äº‹ä»¶è§¸ç™¼
                setTimeout(() => {
                    logEvent('è§¸ç™¼çµ±è¨ˆæ›´æ–°äº‹ä»¶');
                    updateCounter();
                }, 50);
                
                loginStatus.textContent = 'âœ… ç™»å…¥æˆåŠŸ';
                loginStatus.style.color = '#28a745';
                
            } catch (error) {
                loginStatus.textContent = 'âŒ ç™»å…¥å¤±æ•—';
                loginStatus.style.color = '#dc3545';
                logEvent(`ç™»å…¥å¤±æ•—: ${error.message}`);
            }
        }

        async function simulateLogout() {
            const logoutStatus = document.getElementById('logout-status');
            
            if (!currentSessionId) {
                logoutStatus.textContent = 'âŒ æ²’æœ‰æ´»èºæœƒè©±';
                logoutStatus.style.color = '#dc3545';
                return;
            }
            
            try {
                logEvent('=== é–‹å§‹ç™»å‡ºæ¸¬è©¦ ===');
                const logoutStartTime = Date.now();
                
                // æ¨¡æ“¬ä¿®å¾©å¾Œçš„ç™»å‡ºæµç¨‹
                logEvent('æ­¥é©Ÿ 1: èª¿ç”¨ userLogout()');
                await testService.logout(currentSessionId);
                
                logEvent('æ­¥é©Ÿ 2: ç«‹å³è§¸ç™¼çµ±è¨ˆæ›´æ–°äº‹ä»¶');
                updateCounter();
                expectedCount = 0;
                
                logEvent('æ­¥é©Ÿ 3: å»¶é²è§¸ç™¼ç¢ºèªæ›´æ–° (500ms)');
                setTimeout(() => {
                    logEvent('å»¶é²æ›´æ–°è§¸ç™¼');
                    updateCounter();
                }, 500);
                
                const logoutEndTime = Date.now();
                const totalTime = logoutEndTime - logoutStartTime;
                
                logoutStatus.textContent = `âœ… ç™»å‡ºæˆåŠŸ (${totalTime}ms)`;
                logoutStatus.style.color = '#28a745';
                
                currentSessionId = null;
                
            } catch (error) {
                logoutStatus.textContent = 'âŒ ç™»å‡ºå¤±æ•—';
                logoutStatus.style.color = '#dc3545';
                logEvent(`ç™»å‡ºå¤±æ•—: ${error.message}`);
            }
        }

        async function runAutomatedTest() {
            const autoTestStatus = document.getElementById('auto-test-status');
            const testResults = document.getElementById('test-results');
            
            autoTestStatus.textContent = 'ğŸ”„ åŸ·è¡Œä¸­...';
            autoTestStatus.style.color = '#007bff';
            
            clearTimeline();
            testStartTime = Date.now();
            
            try {
                logEvent('=== è‡ªå‹•åŒ–æ¸¬è©¦é–‹å§‹ ===');
                
                // æ­¥é©Ÿ 1: ç™»å…¥
                logEvent('è‡ªå‹•æ¸¬è©¦ - æ­¥é©Ÿ 1: ç”¨æˆ¶ç™»å…¥');
                currentSessionId = await testService.login('auto_test_user');
                expectedCount = 1;
                updateCounter();
                
                await sleep(1000);
                
                // æ­¥é©Ÿ 2: è¨˜éŒ„ç™»å‡ºå‰ç‹€æ…‹
                const beforeLogout = testService.getStats();
                logEvent(`ç™»å‡ºå‰ç‹€æ…‹: ${beforeLogout.onlineUsers} å€‹åœ¨ç·šç”¨æˆ¶`);
                
                // æ­¥é©Ÿ 3: ç™»å‡ºä¸¦æ¸¬é‡æ™‚åº
                logEvent('è‡ªå‹•æ¸¬è©¦ - æ­¥é©Ÿ 2: ç”¨æˆ¶ç™»å‡º');
                const logoutStart = Date.now();
                
                await testService.logout(currentSessionId);
                updateCounter();
                expectedCount = 0;
                
                const immediateUpdate = Date.now();
                const immediateStats = testService.getStats();
                
                // æ­¥é©Ÿ 4: å»¶é²ç¢ºèª
                setTimeout(() => {
                    const delayedUpdate = Date.now();
                    const delayedStats = testService.getStats();
                    
                    // åˆ†æçµæœ
                    const immediateDelay = immediateUpdate - logoutStart;
                    const totalTestTime = Date.now() - testStartTime;
                    
                    const results = `
                        <h4>ğŸ“Š æ¸¬è©¦çµæœåˆ†æ</h4>
                        <p><strong>ç™»å‡ºéŸ¿æ‡‰æ™‚é–“:</strong> ${immediateDelay}ms</p>
                        <p><strong>ç™»å‡ºå‰åœ¨ç·šç”¨æˆ¶:</strong> ${beforeLogout.onlineUsers}</p>
                        <p><strong>ç™»å‡ºå¾Œç«‹å³çµ±è¨ˆ:</strong> ${immediateStats.onlineUsers}</p>
                        <p><strong>å»¶é²ç¢ºèªçµ±è¨ˆ:</strong> ${delayedStats.onlineUsers}</p>
                        <p><strong>ç¸½æ¸¬è©¦æ™‚é–“:</strong> ${totalTestTime}ms</p>
                        
                        <h4>âœ… æ¸¬è©¦è©•ä¼°</h4>
                        ${immediateStats.onlineUsers === 0 ? 
                            '<p style="color: #28a745;">âœ… å„ªç§€ï¼ç™»å‡ºå¾Œè¨ˆæ•¸å™¨ç«‹å³æ›´æ–°</p>' : 
                            '<p style="color: #dc3545;">âŒ å•é¡Œï¼ç™»å‡ºå¾Œè¨ˆæ•¸å™¨æœªç«‹å³æ›´æ–°</p>'
                        }
                        ${immediateDelay < 100 ? 
                            '<p style="color: #28a745;">âœ… éŸ¿æ‡‰æ™‚é–“å„ªç§€ (< 100ms)</p>' : 
                            immediateDelay < 500 ? 
                                '<p style="color: #ffc107;">âš ï¸ éŸ¿æ‡‰æ™‚é–“å¯æ¥å— (< 500ms)</p>' :
                                '<p style="color: #dc3545;">âŒ éŸ¿æ‡‰æ™‚é–“éæ…¢ (> 500ms)</p>'
                        }
                    `;
                    
                    testResults.innerHTML = results;
                    
                    autoTestStatus.textContent = 'âœ… æ¸¬è©¦å®Œæˆ';
                    autoTestStatus.style.color = '#28a745';
                    
                    logEvent('=== è‡ªå‹•åŒ–æ¸¬è©¦å®Œæˆ ===');
                    
                }, 500);
                
                currentSessionId = null;
                
            } catch (error) {
                autoTestStatus.textContent = 'âŒ æ¸¬è©¦å¤±æ•—';
                autoTestStatus.style.color = '#dc3545';
                logEvent(`è‡ªå‹•åŒ–æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        }

        function clearTimeline() {
            document.getElementById('timeline').innerHTML = '';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // åˆå§‹åŒ–
        updateCounter();
        logEvent('ç™»å‡ºæ™‚åºæ¸¬è©¦é é¢å·²è¼‰å…¥');
    </script>
</body>
</html> 