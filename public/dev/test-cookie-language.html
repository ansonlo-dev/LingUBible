<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookie 語言檢測測試</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 8px 8px 0;
            transition: background 0.2s;
        }
        .button:hover {
            background: #2563eb;
        }
        .button.secondary {
            background: #6b7280;
        }
        .button.secondary:hover {
            background: #4b5563;
        }
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
        }
        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        .test-section {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🍪 Cookie 語言檢測測試</h1>
        <p>這個頁面用來測試 Cookie 同意彈窗的語言檢測功能。</p>
    </div>

    <div class="container">
        <h2>📊 當前狀態</h2>
        <div id="current-status">
            <div class="status info">
                <strong>瀏覽器語言：</strong><span id="browser-lang">檢測中...</span>
            </div>
            <div class="status info">
                <strong>檢測到的語言：</strong><span id="detected-lang">檢測中...</span>
            </div>
            <div class="status info">
                <strong>Cookie 中的語言：</strong><span id="cookie-lang">檢測中...</span>
            </div>
            <div class="status info">
                <strong>Cookie 同意狀態：</strong><span id="cookie-consent">檢測中...</span>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>🧪 測試操作</h2>
        <div class="test-section">
            <h3>語言模擬測試</h3>
            <p>模擬不同的瀏覽器語言設定：</p>
            <button class="button" onclick="simulateLanguage('zh-TW')">模擬繁體中文 (zh-TW)</button>
            <button class="button" onclick="simulateLanguage('zh-CN')">模擬簡體中文 (zh-CN)</button>
            <button class="button" onclick="simulateLanguage('en-US')">模擬英文 (en-US)</button>
            <button class="button" onclick="simulateLanguage('ja-JP')">模擬日文 (ja-JP)</button>
        </div>
        
        <div class="test-section">
            <h3>Cookie 管理</h3>
            <button class="button secondary" onclick="clearAllCookies()">清除所有 Cookie</button>
            <button class="button secondary" onclick="clearLanguageCookie()">清除語言 Cookie</button>
            <button class="button secondary" onclick="clearConsentCookie()">清除同意 Cookie</button>
            <button class="button secondary" onclick="refreshPage()">重新載入頁面</button>
        </div>
        
        <div class="test-section">
            <h3>手動測試</h3>
            <p>手動設定語言並測試 Cookie 彈窗：</p>
            <select id="manual-lang-select">
                <option value="zh-TW">繁體中文</option>
                <option value="zh-CN">簡體中文</option>
                <option value="en">English</option>
            </select>
            <button class="button" onclick="setManualLanguage()">設定語言</button>
            <button class="button" onclick="triggerCookiePopup()">觸發 Cookie 彈窗</button>
        </div>
    </div>

    <div class="container">
        <h2>📝 測試日誌</h2>
        <button class="button secondary" onclick="clearLog()">清除日誌</button>
        <div class="log" id="test-log">等待測試操作...</div>
    </div>

    <div class="container">
        <h2>🔍 預期行為</h2>
        <div class="test-section">
            <h3>正確的語言檢測流程：</h3>
            <ol>
                <li><strong>首次訪問：</strong>檢測瀏覽器語言 → 設定對應語言 → 保存到 Cookie → Cookie 彈窗顯示對應語言</li>
                <li><strong>再次訪問：</strong>讀取 Cookie 中的語言 → 直接使用該語言 → Cookie 彈窗（如果需要）顯示該語言</li>
                <li><strong>語言變更：</strong>用戶手動切換語言 → 更新 Cookie → 後續 Cookie 彈窗使用新語言</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h3>測試場景：</h3>
            <ul>
                <li>清除所有 Cookie → 重新載入 → 檢查 Cookie 彈窗語言是否匹配瀏覽器語言</li>
                <li>設定不同語言 → 清除同意 Cookie → 檢查彈窗語言是否正確</li>
                <li>模擬不同瀏覽器語言 → 檢查語言檢測邏輯</li>
            </ul>
        </div>
    </div>

    <script>
        let logContainer = document.getElementById('test-log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`Cookie Test: ${message}`);
        }

        function clearLog() {
            logContainer.textContent = '日誌已清除\n';
        }

        function updateStatus() {
            // 瀏覽器語言
            const browserLang = navigator.language || navigator.languages?.[0] || 'unknown';
            document.getElementById('browser-lang').textContent = browserLang;

            // Cookie 中的語言
            const cookieLang = getCookie('language') || '未設定';
            document.getElementById('cookie-lang').textContent = cookieLang;

            // Cookie 同意狀態
            const consentStatus = localStorage.getItem('cookieConsent') || '未設定';
            document.getElementById('cookie-consent').textContent = consentStatus;

            // 檢測到的語言（模擬語言檢測邏輯）
            let detectedLang = 'en'; // 默認
            if (browserLang) {
                if (browserLang.startsWith('zh-TW') || 
                    browserLang.startsWith('zh-Hant') || 
                    browserLang === 'zh-HK' || 
                    browserLang === 'zh-MO') {
                    detectedLang = 'zh-TW';
                } else if (browserLang.startsWith('zh-CN') || 
                           browserLang.startsWith('zh-Hans') || 
                           browserLang.startsWith('zh-SG') || 
                           browserLang === 'zh') {
                    detectedLang = 'zh-CN';
                } else if (browserLang.startsWith('en')) {
                    detectedLang = 'en';
                }
            }
            document.getElementById('detected-lang').textContent = detectedLang;

            log(`狀態更新 - 瀏覽器: ${browserLang}, 檢測: ${detectedLang}, Cookie: ${cookieLang}, 同意: ${consentStatus}`);
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function setCookie(name, value, days = 365) {
            const expires = new Date();
            expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
            log(`設定 Cookie: ${name}=${value}`);
        }

        function simulateLanguage(lang) {
            log(`模擬瀏覽器語言: ${lang}`);
            // 注意：實際上無法修改 navigator.language，這裡只是記錄
            // 實際測試需要在瀏覽器設定中修改語言
            alert(`注意：無法直接修改瀏覽器語言。請在瀏覽器設定中將語言改為 ${lang}，然後重新載入頁面進行測試。`);
        }

        function clearAllCookies() {
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            localStorage.clear();
            log('已清除所有 Cookie 和 localStorage');
            updateStatus();
        }

        function clearLanguageCookie() {
            document.cookie = "language=;expires=" + new Date().toUTCString() + ";path=/";
            log('已清除語言 Cookie');
            updateStatus();
        }

        function clearConsentCookie() {
            localStorage.removeItem('cookieConsent');
            log('已清除同意 Cookie');
            updateStatus();
        }

        function refreshPage() {
            log('重新載入頁面...');
            window.location.reload();
        }

        function setManualLanguage() {
            const selectedLang = document.getElementById('manual-lang-select').value;
            setCookie('language', selectedLang);
            log(`手動設定語言為: ${selectedLang}`);
            updateStatus();
        }

        function triggerCookiePopup() {
            clearConsentCookie();
            log('已清除同意狀態，Cookie 彈窗應該會在主應用中顯示');
            alert('已清除 Cookie 同意狀態。請返回主應用查看 Cookie 彈窗是否以正確語言顯示。');
        }

        // 初始化
        log('Cookie 語言檢測測試頁面載入完成');
        updateStatus();
        
        // 定期更新狀態
        setInterval(updateStatus, 2000);
    </script>
</body>
</html> 