<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ¶çµ±è¨ˆèª¿è©¦å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 15px 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 3px;
            font-size: 14px;
        }
        .button:hover { background: #0056b3; }
        .button.danger { background: #dc3545; }
        .button.danger:hover { background: #c82333; }
        .button.success { background: #28a745; }
        .button.success:hover { background: #218838; }
        
        .stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #007bff;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .online-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-right: 5px;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .session-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        .session-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ”§ ç”¨æˆ¶çµ±è¨ˆèª¿è©¦å·¥å…·</h1>
        <p>é€™å€‹å·¥å…·å¯ä»¥å¹«åŠ©æ‚¨èª¿è©¦å’Œé©—è­‰ç”¨æˆ¶çµ±è¨ˆåŠŸèƒ½çš„æ­£ç¢ºæ€§ã€‚</p>
        
        <div>
            <button class="button success" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
            <button class="button" onclick="addUser()">â• æ·»åŠ ç”¨æˆ¶</button>
            <button class="button" onclick="removeUser()">â– ç§»é™¤ç”¨æˆ¶</button>
            <button class="button danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰</button>
            <button class="button" onclick="openMainApp()">ğŸ  ä¸»æ‡‰ç”¨</button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“Š å¯¦æ™‚çµ±è¨ˆ</h3>
        <div class="stats-display" id="stats-display">
            <!-- çµ±è¨ˆæ•¸æ“š -->
        </div>
    </div>

    <div class="card">
        <h3>ğŸ” è©³ç´°ä¿¡æ¯</h3>
        <div class="debug-info" id="debug-info">
            è¼‰å…¥ä¸­...
        </div>
    </div>

    <div class="card">
        <h3>ğŸ‘¥ æ´»èºæœƒè©±</h3>
        <div class="session-list" id="session-list">
            <!-- æœƒè©±åˆ—è¡¨ -->
        </div>
    </div>

    <div class="card">
        <h3>ğŸ’¾ æœ¬åœ°å­˜å„²</h3>
        <div>
            <button class="button" onclick="showLocalStorage()">æŸ¥çœ‹ localStorage</button>
            <button class="button" onclick="exportData()">å°å‡ºæ•¸æ“š</button>
            <button class="button" onclick="importData()">å°å…¥æ•¸æ“š</button>
        </div>
        <div class="debug-info" id="storage-info" style="margin-top: 10px;">
            é»æ“Šã€ŒæŸ¥çœ‹ localStorageã€ä¾†é¡¯ç¤ºå­˜å„²çš„æ•¸æ“š
        </div>
    </div>

    <script>
        let userCounter = 1;

        // æ¨¡æ“¬ UserStatsServiceï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
        class DebugUserStatsService {
            constructor() {
                this.loadData();
            }

            loadData() {
                this.stats = this.loadStatsFromStorage();
                this.sessions = new Map();
                this.loadSessionsFromStorage();
            }

            loadStatsFromStorage() {
                try {
                    const stored = localStorage.getItem('userStats');
                    if (stored) {
                        return JSON.parse(stored);
                    }
                } catch (error) {
                    console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
                }
                
                return {
                    totalUsers: 0,
                    onlineUsers: 0,
                    todayLogins: 0,
                    thisMonthLogins: 0,
                    lastUpdated: new Date().toISOString()
                };
            }

            loadSessionsFromStorage() {
                try {
                    const stored = localStorage.getItem('userSessions');
                    if (stored) {
                        const sessions = JSON.parse(stored);
                        const now = Date.now();
                        
                        Object.entries(sessions).forEach(([sessionId, session]) => {
                            if (now - session.lastActivity < 30 * 60 * 1000) {
                                this.sessions.set(sessionId, session);
                            }
                        });
                    }
                } catch (error) {
                    console.error('è¼‰å…¥æœƒè©±å¤±æ•—:', error);
                }
            }

            saveData() {
                try {
                    localStorage.setItem('userStats', JSON.stringify(this.stats));
                    const sessionsObj = Object.fromEntries(this.sessions);
                    localStorage.setItem('userSessions', JSON.stringify(sessionsObj));
                } catch (error) {
                    console.error('ä¿å­˜æ•¸æ“šå¤±æ•—:', error);
                }
            }

            addUser() {
                const userId = `debug_user_${userCounter++}`;
                const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const now = Date.now();

                // æª¢æŸ¥æ˜¯å¦å·²æœ‰æœƒè©±
                const existingSession = Array.from(this.sessions.values())
                    .find(session => session.userId === userId);

                if (!existingSession) {
                    this.stats.todayLogins++;
                    this.stats.thisMonthLogins++;
                    
                    const loggedUsers = JSON.parse(localStorage.getItem('loggedUsers') || '[]');
                    if (!loggedUsers.includes(userId)) {
                        this.stats.totalUsers++;
                        loggedUsers.push(userId);
                        localStorage.setItem('loggedUsers', JSON.stringify(loggedUsers));
                    }
                }

                this.sessions.set(sessionId, {
                    userId,
                    loginTime: now,
                    lastActivity: now,
                    sessionId
                });

                this.updateOnlineCount();
                this.saveData();
                
                return { userId, sessionId };
            }

            removeUser() {
                const sessions = Array.from(this.sessions.values());
                if (sessions.length > 0) {
                    const randomSession = sessions[Math.floor(Math.random() * sessions.length)];
                    this.sessions.delete(randomSession.sessionId);
                    this.updateOnlineCount();
                    this.saveData();
                    return randomSession.userId;
                }
                return null;
            }

            updateOnlineCount() {
                this.stats.onlineUsers = this.sessions.size;
                this.stats.lastUpdated = new Date().toISOString();
            }

            getStats() {
                return { ...this.stats };
            }

            getSessions() {
                return Array.from(this.sessions.values());
            }

            clearAll() {
                this.sessions.clear();
                this.stats = {
                    totalUsers: 0,
                    onlineUsers: 0,
                    todayLogins: 0,
                    thisMonthLogins: 0,
                    lastUpdated: new Date().toISOString()
                };
                
                localStorage.removeItem('userStats');
                localStorage.removeItem('userSessions');
                localStorage.removeItem('loggedUsers');
            }
        }

        const debugService = new DebugUserStatsService();

        function refreshData() {
            const stats = debugService.getStats();
            const sessions = debugService.getSessions();
            
            // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
            document.getElementById('stats-display').innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">
                        <span class="online-dot"></span>${stats.onlineUsers}
                    </div>
                    <div class="stat-label">åœ¨ç·šç”¨æˆ¶</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.totalUsers}</div>
                    <div class="stat-label">ç¸½ç”¨æˆ¶æ•¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.todayLogins}</div>
                    <div class="stat-label">ä»Šæ—¥ç™»å…¥</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.thisMonthLogins}</div>
                    <div class="stat-label">æœ¬æœˆç™»å…¥</div>
                </div>
            `;

            // æ›´æ–°èª¿è©¦ä¿¡æ¯
            const now = Date.now();
            document.getElementById('debug-info').textContent = `çµ±è¨ˆæ•¸æ“š:
ç¸½ç”¨æˆ¶æ•¸: ${stats.totalUsers}
åœ¨ç·šç”¨æˆ¶æ•¸: ${stats.onlineUsers}
ä»Šæ—¥ç™»å…¥: ${stats.todayLogins}
æœ¬æœˆç™»å…¥: ${stats.thisMonthLogins}
æœ€å¾Œæ›´æ–°: ${new Date(stats.lastUpdated).toLocaleString()}

æœƒè©±ä¿¡æ¯:
æœƒè©± Map å¤§å°: ${debugService.sessions.size}
æ´»èºæœƒè©±æ•¸: ${sessions.length}
ç•¶å‰æ™‚é–“: ${new Date().toLocaleString()}`;

            // æ›´æ–°æœƒè©±åˆ—è¡¨
            const sessionListHtml = sessions.map(session => {
                const idleTime = Math.floor((now - session.lastActivity) / 1000);
                const loginTime = new Date(session.loginTime).toLocaleTimeString();
                return `<div class="session-item">
                    <strong>${session.userId}</strong> | 
                    ç™»å…¥: ${loginTime} | 
                    é–’ç½®: ${idleTime}ç§’ | 
                    ID: ${session.sessionId.substr(-8)}
                </div>`;
            }).join('');
            
            document.getElementById('session-list').innerHTML = sessionListHtml || '<div class="session-item">æ²’æœ‰æ´»èºæœƒè©±</div>';
        }

        function addUser() {
            const result = debugService.addUser();
            console.log('æ·»åŠ ç”¨æˆ¶:', result);
            refreshData();
        }

        function removeUser() {
            const removedUser = debugService.removeUser();
            if (removedUser) {
                console.log('ç§»é™¤ç”¨æˆ¶:', removedUser);
            } else {
                console.log('æ²’æœ‰ç”¨æˆ¶å¯ä»¥ç§»é™¤');
            }
            refreshData();
        }

        function clearAll() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ•¸æ“šå—ï¼Ÿ')) {
                debugService.clearAll();
                refreshData();
                console.log('æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤');
            }
        }

        function showLocalStorage() {
            const userStats = localStorage.getItem('userStats');
            const userSessions = localStorage.getItem('userSessions');
            const loggedUsers = localStorage.getItem('loggedUsers');
            
            document.getElementById('storage-info').textContent = `localStorage å…§å®¹:

userStats:
${userStats ? JSON.stringify(JSON.parse(userStats), null, 2) : '(ç©º)'}

userSessions:
${userSessions ? JSON.stringify(JSON.parse(userSessions), null, 2) : '(ç©º)'}

loggedUsers:
${loggedUsers ? JSON.stringify(JSON.parse(loggedUsers), null, 2) : '(ç©º)'}`;
        }

        function exportData() {
            const data = {
                userStats: localStorage.getItem('userStats'),
                userSessions: localStorage.getItem('userSessions'),
                loggedUsers: localStorage.getItem('loggedUsers'),
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `user-stats-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.userStats) localStorage.setItem('userStats', data.userStats);
                            if (data.userSessions) localStorage.setItem('userSessions', data.userSessions);
                            if (data.loggedUsers) localStorage.setItem('loggedUsers', data.loggedUsers);
                            
                            debugService.loadData();
                            refreshData();
                            alert('æ•¸æ“šå°å…¥æˆåŠŸï¼');
                        } catch (error) {
                            alert('å°å…¥å¤±æ•—ï¼š' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function openMainApp() {
            window.open('/', '_blank');
        }

        // åˆå§‹åŒ–
        refreshData();
        
        // å®šæœŸåˆ·æ–°
        setInterval(refreshData, 5000);
    </script>
</body>
</html> 