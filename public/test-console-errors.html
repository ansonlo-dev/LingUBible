<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ§åˆ¶å°éŒ¯èª¤æ¸¬è©¦ - LingUBible</title>
    <link rel="manifest" href="/manifest-dynamic.json?lang=zh-TW" id="manifest-link" />
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #dc2626;
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }
        .success {
            background-color: #f0fdf4;
            border-color: #22c55e;
        }
        .error {
            background-color: #fef2f2;
            border-color: #ef4444;
        }
        .info {
            background-color: #f0f9ff;
            border-color: #3b82f6;
        }
        pre {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #b91c1c;
        }
        .log {
            max-height: 200px;
            overflow-y: auto;
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ§åˆ¶å°éŒ¯èª¤ä¿®å¾©æ¸¬è©¦</h1>
        
        <div class="test-section info">
            <h3>ğŸ“‹ æ¸¬è©¦é …ç›®</h3>
            <ul>
                <li>âœ… Service Worker è¨»å†Šï¼ˆé¿å… MIME type éŒ¯èª¤ï¼‰</li>
                <li>âœ… PWA Manifest æˆªåœ–è¼‰å…¥ï¼ˆä½¿ç”¨ä½”ä½ç¬¦ï¼‰</li>
                <li>âœ… JavaScript æª”æ¡ˆè¼‰å…¥æª¢æŸ¥</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ” Service Worker æ¸¬è©¦</h3>
            <button onclick="testServiceWorker()">æ¸¬è©¦ Service Worker</button>
            <div id="sw-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“± PWA Manifest æ¸¬è©¦</h3>
            <button onclick="testManifest()">æ¸¬è©¦ Manifest</button>
            <button onclick="loadScreenshots()">è¼‰å…¥æˆªåœ–</button>
            <div id="manifest-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“œ JavaScript æª”æ¡ˆæ¸¬è©¦</h3>
            <button onclick="testJSFiles()">æ¸¬è©¦ JS æª”æ¡ˆ</button>
            <div id="js-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ–¥ï¸ æ§åˆ¶å°æ—¥èªŒ</h3>
            <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
            <div id="console-log" class="log"></div>
        </div>
    </div>

    <script>
        // æ””æˆªæ§åˆ¶å°è¼¸å‡º
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        const logDiv = document.getElementById('console-log');

        function addToLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${type}: ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog('LOG', args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLog('WARN', args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog('ERROR', args.join(' '));
        };

        function clearLog() {
            logDiv.innerHTML = '';
        }

        async function testServiceWorker() {
            const resultDiv = document.getElementById('sw-result');
            resultDiv.innerHTML = '<p>æ¸¬è©¦ä¸­...</p>';

            if ('serviceWorker' in navigator) {
                try {
                    // æª¢æŸ¥æ˜¯å¦å·²è¨»å†Š
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        resultDiv.innerHTML = `
                            <div class="success">
                                <h4>âœ… Service Worker å·²è¨»å†Š</h4>
                                <p>Scope: ${registration.scope}</p>
                                <p>ç‹€æ…‹: ${registration.active ? 'æ´»èº' : 'æœªæ´»èº'}</p>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="info">
                                <h4>â„¹ï¸ Service Worker æœªè¨»å†Š</h4>
                                <p>é€™åœ¨é–‹ç™¼ç’°å¢ƒä¸­æ˜¯æ­£å¸¸çš„ï¼Œå¦‚æœ dev-sw.js ä¸å­˜åœ¨çš„è©±</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>âŒ Service Worker æ¸¬è©¦å¤±æ•—</h4>
                            <pre>${error.message}</pre>
                        </div>
                    `;
                }
            } else {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ ç€è¦½å™¨ä¸æ”¯æ´ Service Worker</h4>
                    </div>
                `;
            }
        }

        async function testManifest() {
            const resultDiv = document.getElementById('manifest-result');
            resultDiv.innerHTML = '<p>æ¸¬è©¦ä¸­...</p>';

            try {
                const manifestLink = document.getElementById('manifest-link');
                const response = await fetch(manifestLink.href);
                
                if (response.ok) {
                    const manifest = await response.json();
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>âœ… Manifest è¼‰å…¥æˆåŠŸ</h4>
                            <p>åç¨±: ${manifest.name}</p>
                            <p>æˆªåœ–æ•¸é‡: ${manifest.screenshots ? manifest.screenshots.length : 0}</p>
                            <pre>${JSON.stringify(manifest.screenshots, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>âŒ Manifest è¼‰å…¥å¤±æ•—</h4>
                            <p>ç‹€æ…‹ç¢¼: ${response.status}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ Manifest æ¸¬è©¦å¤±æ•—</h4>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        async function loadScreenshots() {
            const resultDiv = document.getElementById('manifest-result');
            
            try {
                // æ¸¬è©¦è¼‰å…¥ä½”ä½ç¬¦æˆªåœ–
                const desktopImg = new Image();
                const mobileImg = new Image();
                
                const desktopPromise = new Promise((resolve, reject) => {
                    desktopImg.onload = () => resolve('desktop');
                    desktopImg.onerror = () => reject('desktop');
                    desktopImg.src = '/screenshot-placeholder.svg';
                });

                const mobilePromise = new Promise((resolve, reject) => {
                    mobileImg.onload = () => resolve('mobile');
                    mobileImg.onerror = () => reject('mobile');
                    mobileImg.src = '/screenshot-mobile-placeholder.svg';
                });

                const results = await Promise.allSettled([desktopPromise, mobilePromise]);
                
                let html = '<div class="success"><h4>ğŸ“¸ æˆªåœ–è¼‰å…¥æ¸¬è©¦çµæœ</h4>';
                results.forEach((result, index) => {
                    const type = index === 0 ? 'æ¡Œé¢ç‰ˆ' : 'æ‰‹æ©Ÿç‰ˆ';
                    if (result.status === 'fulfilled') {
                        html += `<p>âœ… ${type}æˆªåœ–è¼‰å…¥æˆåŠŸ</p>`;
                    } else {
                        html += `<p>âŒ ${type}æˆªåœ–è¼‰å…¥å¤±æ•—</p>`;
                    }
                });
                html += '</div>';
                
                resultDiv.innerHTML += html;
                
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="error">
                        <h4>âŒ æˆªåœ–è¼‰å…¥æ¸¬è©¦å¤±æ•—</h4>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        async function testJSFiles() {
            const resultDiv = document.getElementById('js-result');
            resultDiv.innerHTML = '<p>æ¸¬è©¦ä¸­...</p>';

            const jsFiles = [
                '/sw-register.js',
                '/badge-hide.js',
                '/manifest.js'
            ];

            let html = '<div class="info"><h4>ğŸ“„ JavaScript æª”æ¡ˆæ¸¬è©¦</h4>';
            
            for (const file of jsFiles) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    const contentType = response.headers.get('content-type');
                    
                    if (response.ok && contentType && contentType.includes('javascript')) {
                        html += `<p>âœ… ${file} - OK (${contentType})</p>`;
                    } else {
                        html += `<p>âš ï¸ ${file} - ç‹€æ…‹: ${response.status}, é¡å‹: ${contentType}</p>`;
                    }
                } catch (error) {
                    html += `<p>âŒ ${file} - éŒ¯èª¤: ${error.message}</p>`;
                }
            }
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦
        window.addEventListener('load', function() {
            console.log('ğŸš€ æ§åˆ¶å°éŒ¯èª¤æ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('ğŸ“ ç•¶å‰ URL:', window.location.href);
            console.log('ğŸŒ User Agent:', navigator.userAgent);
        });
    </script>

    <!-- è¼‰å…¥å¯¦éš›çš„è…³æœ¬ä¾†æ¸¬è©¦ -->
    <script src="/sw-register.js" defer></script>
    <script src="/badge-hide.js" defer></script>
</body>
</html> 