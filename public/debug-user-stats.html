<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用戶統計調試工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 15px 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 3px;
            font-size: 14px;
        }
        .button:hover { background: #0056b3; }
        .button.danger { background: #dc3545; }
        .button.danger:hover { background: #c82333; }
        .button.success { background: #28a745; }
        .button.success:hover { background: #218838; }
        
        .stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #007bff;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .online-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-right: 5px;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .session-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        .session-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>🔧 用戶統計調試工具</h1>
        <p>這個工具可以幫助您調試和驗證用戶統計功能的正確性。</p>
        
        <div>
            <button class="button success" onclick="refreshData()">🔄 刷新數據</button>
            <button class="button" onclick="addUser()">➕ 添加用戶</button>
            <button class="button" onclick="removeUser()">➖ 移除用戶</button>
            <button class="button danger" onclick="clearAll()">🗑️ 清除所有</button>
            <button class="button" onclick="openMainApp()">🏠 主應用</button>
        </div>
    </div>

    <div class="card">
        <h3>📊 實時統計</h3>
        <div class="stats-display" id="stats-display">
            <!-- 統計數據 -->
        </div>
    </div>

    <div class="card">
        <h3>🔍 詳細信息</h3>
        <div class="debug-info" id="debug-info">
            載入中...
        </div>
    </div>

    <div class="card">
        <h3>👥 活躍會話</h3>
        <div class="session-list" id="session-list">
            <!-- 會話列表 -->
        </div>
    </div>

    <div class="card">
        <h3>💾 本地存儲</h3>
        <div>
            <button class="button" onclick="showLocalStorage()">查看 localStorage</button>
            <button class="button" onclick="exportData()">導出數據</button>
            <button class="button" onclick="importData()">導入數據</button>
        </div>
        <div class="debug-info" id="storage-info" style="margin-top: 10px;">
            點擊「查看 localStorage」來顯示存儲的數據
        </div>
    </div>

    <script>
        let userCounter = 1;

        // 模擬 UserStatsService（簡化版本）
        class DebugUserStatsService {
            constructor() {
                this.loadData();
            }

            loadData() {
                this.stats = this.loadStatsFromStorage();
                this.sessions = new Map();
                this.loadSessionsFromStorage();
            }

            loadStatsFromStorage() {
                try {
                    const stored = localStorage.getItem('userStats');
                    if (stored) {
                        return JSON.parse(stored);
                    }
                } catch (error) {
                    console.error('載入統計失敗:', error);
                }
                
                return {
                    totalUsers: 0,
                    onlineUsers: 0,
                    todayLogins: 0,
                    thisMonthLogins: 0,
                    lastUpdated: new Date().toISOString()
                };
            }

            loadSessionsFromStorage() {
                try {
                    const stored = localStorage.getItem('userSessions');
                    if (stored) {
                        const sessions = JSON.parse(stored);
                        const now = Date.now();
                        
                        Object.entries(sessions).forEach(([sessionId, session]) => {
                            if (now - session.lastActivity < 30 * 60 * 1000) {
                                this.sessions.set(sessionId, session);
                            }
                        });
                    }
                } catch (error) {
                    console.error('載入會話失敗:', error);
                }
            }

            saveData() {
                try {
                    localStorage.setItem('userStats', JSON.stringify(this.stats));
                    const sessionsObj = Object.fromEntries(this.sessions);
                    localStorage.setItem('userSessions', JSON.stringify(sessionsObj));
                } catch (error) {
                    console.error('保存數據失敗:', error);
                }
            }

            addUser() {
                const userId = `debug_user_${userCounter++}`;
                const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const now = Date.now();

                // 檢查是否已有會話
                const existingSession = Array.from(this.sessions.values())
                    .find(session => session.userId === userId);

                if (!existingSession) {
                    this.stats.todayLogins++;
                    this.stats.thisMonthLogins++;
                    
                    const loggedUsers = JSON.parse(localStorage.getItem('loggedUsers') || '[]');
                    if (!loggedUsers.includes(userId)) {
                        this.stats.totalUsers++;
                        loggedUsers.push(userId);
                        localStorage.setItem('loggedUsers', JSON.stringify(loggedUsers));
                    }
                }

                this.sessions.set(sessionId, {
                    userId,
                    loginTime: now,
                    lastActivity: now,
                    sessionId
                });

                this.updateOnlineCount();
                this.saveData();
                
                return { userId, sessionId };
            }

            removeUser() {
                const sessions = Array.from(this.sessions.values());
                if (sessions.length > 0) {
                    const randomSession = sessions[Math.floor(Math.random() * sessions.length)];
                    this.sessions.delete(randomSession.sessionId);
                    this.updateOnlineCount();
                    this.saveData();
                    return randomSession.userId;
                }
                return null;
            }

            updateOnlineCount() {
                this.stats.onlineUsers = this.sessions.size;
                this.stats.lastUpdated = new Date().toISOString();
            }

            getStats() {
                return { ...this.stats };
            }

            getSessions() {
                return Array.from(this.sessions.values());
            }

            clearAll() {
                this.sessions.clear();
                this.stats = {
                    totalUsers: 0,
                    onlineUsers: 0,
                    todayLogins: 0,
                    thisMonthLogins: 0,
                    lastUpdated: new Date().toISOString()
                };
                
                localStorage.removeItem('userStats');
                localStorage.removeItem('userSessions');
                localStorage.removeItem('loggedUsers');
            }
        }

        const debugService = new DebugUserStatsService();

        function refreshData() {
            const stats = debugService.getStats();
            const sessions = debugService.getSessions();
            
            // 更新統計顯示
            document.getElementById('stats-display').innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">
                        <span class="online-dot"></span>${stats.onlineUsers}
                    </div>
                    <div class="stat-label">在線用戶</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.totalUsers}</div>
                    <div class="stat-label">總用戶數</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.todayLogins}</div>
                    <div class="stat-label">今日登入</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.thisMonthLogins}</div>
                    <div class="stat-label">本月登入</div>
                </div>
            `;

            // 更新調試信息
            const now = Date.now();
            document.getElementById('debug-info').textContent = `統計數據:
總用戶數: ${stats.totalUsers}
在線用戶數: ${stats.onlineUsers}
今日登入: ${stats.todayLogins}
本月登入: ${stats.thisMonthLogins}
最後更新: ${new Date(stats.lastUpdated).toLocaleString()}

會話信息:
會話 Map 大小: ${debugService.sessions.size}
活躍會話數: ${sessions.length}
當前時間: ${new Date().toLocaleString()}`;

            // 更新會話列表
            const sessionListHtml = sessions.map(session => {
                const idleTime = Math.floor((now - session.lastActivity) / 1000);
                const loginTime = new Date(session.loginTime).toLocaleTimeString();
                return `<div class="session-item">
                    <strong>${session.userId}</strong> | 
                    登入: ${loginTime} | 
                    閒置: ${idleTime}秒 | 
                    ID: ${session.sessionId.substr(-8)}
                </div>`;
            }).join('');
            
            document.getElementById('session-list').innerHTML = sessionListHtml || '<div class="session-item">沒有活躍會話</div>';
        }

        function addUser() {
            const result = debugService.addUser();
            console.log('添加用戶:', result);
            refreshData();
        }

        function removeUser() {
            const removedUser = debugService.removeUser();
            if (removedUser) {
                console.log('移除用戶:', removedUser);
            } else {
                console.log('沒有用戶可以移除');
            }
            refreshData();
        }

        function clearAll() {
            if (confirm('確定要清除所有數據嗎？')) {
                debugService.clearAll();
                refreshData();
                console.log('所有數據已清除');
            }
        }

        function showLocalStorage() {
            const userStats = localStorage.getItem('userStats');
            const userSessions = localStorage.getItem('userSessions');
            const loggedUsers = localStorage.getItem('loggedUsers');
            
            document.getElementById('storage-info').textContent = `localStorage 內容:

userStats:
${userStats ? JSON.stringify(JSON.parse(userStats), null, 2) : '(空)'}

userSessions:
${userSessions ? JSON.stringify(JSON.parse(userSessions), null, 2) : '(空)'}

loggedUsers:
${loggedUsers ? JSON.stringify(JSON.parse(loggedUsers), null, 2) : '(空)'}`;
        }

        function exportData() {
            const data = {
                userStats: localStorage.getItem('userStats'),
                userSessions: localStorage.getItem('userSessions'),
                loggedUsers: localStorage.getItem('loggedUsers'),
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `user-stats-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.userStats) localStorage.setItem('userStats', data.userStats);
                            if (data.userSessions) localStorage.setItem('userSessions', data.userSessions);
                            if (data.loggedUsers) localStorage.setItem('loggedUsers', data.loggedUsers);
                            
                            debugService.loadData();
                            refreshData();
                            alert('數據導入成功！');
                        } catch (error) {
                            alert('導入失敗：' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function openMainApp() {
            window.open('/', '_blank');
        }

        // 初始化
        refreshData();
        
        // 定期刷新
        setInterval(refreshData, 5000);
    </script>
</body>
</html> 