<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA å®‰è£èª¿è©¦ - LingUBible</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .icon-test {
            display: inline-block;
            margin: 5px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .icon-test img {
            width: 32px;
            height: 32px;
            display: block;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ PWA å®‰è£èª¿è©¦å·¥å…·</h1>
    <p>æ­¤é é¢ç”¨æ–¼è¨ºæ–· PWA å®‰è£å•é¡Œï¼Œæª¢æŸ¥æ‰€æœ‰å¿…è¦æ¢ä»¶ã€‚</p>

    <div class="test-section">
        <h2>ğŸ“‹ åŸºæœ¬æª¢æŸ¥</h2>
        <div id="basic-checks"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“„ Manifest æª¢æŸ¥</h2>
        <div id="manifest-checks"></div>
        <button onclick="testManifest()">é‡æ–°æª¢æŸ¥ Manifest</button>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ Service Worker æª¢æŸ¥</h2>
        <div id="sw-checks"></div>
        <button onclick="testServiceWorker()">é‡æ–°æª¢æŸ¥ SW</button>
    </div>

    <div class="test-section">
        <h2>ğŸ–¼ï¸ åœ–æ¨™æª¢æŸ¥</h2>
        <div id="icon-checks"></div>
        <button onclick="testIcons()">æª¢æŸ¥åœ–æ¨™</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“± PWA å®‰è£æª¢æŸ¥</h2>
        <div id="install-checks"></div>
        <button onclick="triggerInstall()" id="install-btn" disabled>è§¸ç™¼å®‰è£</button>
        <button onclick="checkInstallability()">æª¢æŸ¥å¯å®‰è£æ€§</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š è©³ç´°ä¿¡æ¯</h2>
        <pre id="detailed-info"></pre>
        <button onclick="refreshInfo()">åˆ·æ–°ä¿¡æ¯</button>
    </div>

    <script>
        let deferredPrompt = null;
        let manifestData = null;

        // åŸºæœ¬æª¢æŸ¥
        function performBasicChecks() {
            const checks = document.getElementById('basic-checks');
            let html = '';

            // HTTPS æª¢æŸ¥
            const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
            html += `<div class="status ${isHTTPS ? 'success' : 'error'}">
                HTTPS: ${isHTTPS ? 'âœ… å·²å•Ÿç”¨' : 'âŒ æœªå•Ÿç”¨ (å¿…éœ€)'}
            </div>`;

            // Service Worker æ”¯æ´
            const hasSW = 'serviceWorker' in navigator;
            html += `<div class="status ${hasSW ? 'success' : 'error'}">
                Service Worker æ”¯æ´: ${hasSW ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´'}
            </div>`;

            // ç€è¦½å™¨æª¢æŸ¥
            const userAgent = navigator.userAgent;
            const isChrome = userAgent.includes('Chrome') && !userAgent.includes('Edg');
            const isEdge = userAgent.includes('Edg');
            const isFirefox = userAgent.includes('Firefox');
            const isSafari = userAgent.includes('Safari') && !userAgent.includes('Chrome');
            
            let browserSupport = 'unknown';
            if (isChrome) browserSupport = 'Chrome (å®Œå…¨æ”¯æ´)';
            else if (isEdge) browserSupport = 'Edge (å®Œå…¨æ”¯æ´)';
            else if (isFirefox) browserSupport = 'Firefox (éƒ¨åˆ†æ”¯æ´)';
            else if (isSafari) browserSupport = 'Safari (éƒ¨åˆ†æ”¯æ´)';

            html += `<div class="status info">
                ç€è¦½å™¨: ${browserSupport}
            </div>`;

            // é¡¯ç¤ºæ¨¡å¼æª¢æŸ¥
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            html += `<div class="status ${isStandalone ? 'warning' : 'info'}">
                é¡¯ç¤ºæ¨¡å¼: ${isStandalone ? 'âš ï¸ å·²å®‰è£ (Standalone)' : 'ğŸŒ ç€è¦½å™¨æ¨¡å¼'}
            </div>`;

            checks.innerHTML = html;
        }

        // Manifest æª¢æŸ¥
        async function testManifest() {
            const checks = document.getElementById('manifest-checks');
            let html = '';

            try {
                // æª¢æŸ¥ manifest link
                const manifestLink = document.querySelector('link[rel="manifest"]');
                if (!manifestLink) {
                    html += `<div class="status error">âŒ æœªæ‰¾åˆ° manifest link æ¨™ç±¤</div>`;
                    checks.innerHTML = html;
                    return;
                }

                html += `<div class="status success">âœ… Manifest link: ${manifestLink.href}</div>`;

                // ç²å– manifest å…§å®¹
                const response = await fetch(manifestLink.href);
                if (!response.ok) {
                    html += `<div class="status error">âŒ ç„¡æ³•è¼‰å…¥ manifest: ${response.status}</div>`;
                    checks.innerHTML = html;
                    return;
                }

                manifestData = await response.json();
                html += `<div class="status success">âœ… Manifest è¼‰å…¥æˆåŠŸ</div>`;

                // æª¢æŸ¥å¿…è¦æ¬„ä½
                const requiredFields = ['name', 'short_name', 'start_url', 'display', 'icons'];
                for (const field of requiredFields) {
                    const hasField = manifestData[field];
                    html += `<div class="status ${hasField ? 'success' : 'error'}">
                        ${hasField ? 'âœ…' : 'âŒ'} ${field}: ${hasField ? 'å·²è¨­å®š' : 'ç¼ºå°‘'}
                    </div>`;
                }

                // æª¢æŸ¥åœ–æ¨™
                if (manifestData.icons && manifestData.icons.length > 0) {
                    const hasLargeIcon = manifestData.icons.some(icon => 
                        icon.sizes && (icon.sizes.includes('192x192') || icon.sizes.includes('512x512'))
                    );
                    html += `<div class="status ${hasLargeIcon ? 'success' : 'warning'}">
                        ${hasLargeIcon ? 'âœ…' : 'âš ï¸'} å¤§å°ºå¯¸åœ–æ¨™ (192x192 æˆ– 512x512): ${hasLargeIcon ? 'å·²è¨­å®š' : 'å»ºè­°æ·»åŠ '}
                    </div>`;
                }

                // æª¢æŸ¥æˆªåœ–
                if (manifestData.screenshots && manifestData.screenshots.length > 0) {
                    html += `<div class="status success">âœ… æˆªåœ–: ${manifestData.screenshots.length} å€‹</div>`;
                } else {
                    html += `<div class="status warning">âš ï¸ æˆªåœ–: æœªè¨­å®š (å»ºè­°æ·»åŠ ä»¥æé«˜å®‰è£ç‡)</div>`;
                }

            } catch (error) {
                html += `<div class="status error">âŒ Manifest æª¢æŸ¥å¤±æ•—: ${error.message}</div>`;
            }

            checks.innerHTML = html;
        }

        // Service Worker æª¢æŸ¥
        async function testServiceWorker() {
            const checks = document.getElementById('sw-checks');
            let html = '';

            if (!('serviceWorker' in navigator)) {
                html += `<div class="status error">âŒ ç€è¦½å™¨ä¸æ”¯æ´ Service Worker</div>`;
                checks.innerHTML = html;
                return;
            }

            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    html += `<div class="status success">âœ… Service Worker å·²è¨»å†Š</div>`;
                    html += `<div class="status info">ğŸ“„ Scope: ${registration.scope}</div>`;
                    
                    if (registration.active) {
                        html += `<div class="status success">âœ… Service Worker å·²æ¿€æ´»</div>`;
                        html += `<div class="status info">ğŸ“„ Script URL: ${registration.active.scriptURL}</div>`;
                    } else {
                        html += `<div class="status warning">âš ï¸ Service Worker æœªæ¿€æ´»</div>`;
                    }
                } else {
                    html += `<div class="status warning">âš ï¸ Service Worker æœªè¨»å†Š</div>`;
                    
                    // å˜—è©¦æª¢æŸ¥ SW æ–‡ä»¶
                    const swPaths = ['/sw.js', '/dev-sw.js'];
                    for (const path of swPaths) {
                        try {
                            const response = await fetch(path, { method: 'HEAD' });
                            html += `<div class="status ${response.ok ? 'info' : 'warning'}">
                                ${response.ok ? 'ğŸ“„' : 'âš ï¸'} ${path}: ${response.ok ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}
                            </div>`;
                        } catch (e) {
                            html += `<div class="status warning">âš ï¸ ${path}: æª¢æŸ¥å¤±æ•—</div>`;
                        }
                    }
                }
            } catch (error) {
                html += `<div class="status error">âŒ Service Worker æª¢æŸ¥å¤±æ•—: ${error.message}</div>`;
            }

            checks.innerHTML = html;
        }

        // åœ–æ¨™æª¢æŸ¥
        async function testIcons() {
            const checks = document.getElementById('icon-checks');
            let html = '';

            if (!manifestData) {
                html += `<div class="status warning">âš ï¸ è«‹å…ˆæª¢æŸ¥ Manifest</div>`;
                checks.innerHTML = html;
                return;
            }

            if (!manifestData.icons || manifestData.icons.length === 0) {
                html += `<div class="status error">âŒ Manifest ä¸­æ²’æœ‰åœ–æ¨™</div>`;
                checks.innerHTML = html;
                return;
            }

            html += `<div class="status info">ğŸ“Š ç¸½å…± ${manifestData.icons.length} å€‹åœ–æ¨™</div>`;

            for (const icon of manifestData.icons) {
                try {
                    const response = await fetch(icon.src, { method: 'HEAD' });
                    const status = response.ok ? 'success' : 'error';
                    const statusText = response.ok ? 'âœ…' : 'âŒ';
                    
                    html += `<div class="status ${status}">
                        ${statusText} ${icon.sizes || 'any'} (${icon.type || 'unknown'}): ${icon.src}
                        ${icon.purpose ? ` - ${icon.purpose}` : ''}
                    </div>`;

                    // é¡¯ç¤ºåœ–æ¨™é è¦½
                    if (response.ok && icon.type && icon.type.startsWith('image/')) {
                        html += `<div class="icon-test">
                            <img src="${icon.src}" alt="${icon.sizes}" title="${icon.src}">
                            <br><small>${icon.sizes}</small>
                        </div>`;
                    }
                } catch (error) {
                    html += `<div class="status error">âŒ ${icon.sizes || 'any'}: æª¢æŸ¥å¤±æ•— - ${error.message}</div>`;
                }
            }

            checks.innerHTML = html;
        }

        // PWA å®‰è£æª¢æŸ¥
        function checkInstallability() {
            const checks = document.getElementById('install-checks');
            let html = '';

            // æª¢æŸ¥æ˜¯å¦å·²å®‰è£
            const isInstalled = window.matchMedia('(display-mode: standalone)').matches;
            html += `<div class="status ${isInstalled ? 'warning' : 'info'}">
                ${isInstalled ? 'âš ï¸ PWA å·²å®‰è£' : 'ğŸ“± PWA æœªå®‰è£'}
            </div>`;

            // æª¢æŸ¥å®‰è£æç¤º
            html += `<div class="status ${deferredPrompt ? 'success' : 'warning'}">
                ${deferredPrompt ? 'âœ… å®‰è£æç¤ºå¯ç”¨' : 'âš ï¸ å®‰è£æç¤ºä¸å¯ç”¨'}
            </div>`;

            // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
            const userAgent = navigator.userAgent;
            const supportsInstall = userAgent.includes('Chrome') || userAgent.includes('Edg');
            html += `<div class="status ${supportsInstall ? 'success' : 'warning'}">
                ${supportsInstall ? 'âœ…' : 'âš ï¸'} ç€è¦½å™¨å®‰è£æ”¯æ´: ${supportsInstall ? 'æ”¯æ´' : 'å¯èƒ½ä¸æ”¯æ´'}
            </div>`;

            document.getElementById('install-btn').disabled = !deferredPrompt;
            checks.innerHTML = html;
        }

        // è§¸ç™¼å®‰è£
        async function triggerInstall() {
            if (!deferredPrompt) {
                alert('å®‰è£æç¤ºä¸å¯ç”¨');
                return;
            }

            try {
                deferredPrompt.prompt();
                const choiceResult = await deferredPrompt.userChoice;
                
                const checks = document.getElementById('install-checks');
                checks.innerHTML += `<div class="status info">
                    ğŸ‘¤ ç”¨æˆ¶é¸æ“‡: ${choiceResult.outcome}
                </div>`;

                deferredPrompt = null;
                document.getElementById('install-btn').disabled = true;
            } catch (error) {
                alert('å®‰è£å¤±æ•—: ' + error.message);
            }
        }

        // åˆ·æ–°è©³ç´°ä¿¡æ¯
        function refreshInfo() {
            const info = {
                url: location.href,
                protocol: location.protocol,
                hostname: location.hostname,
                userAgent: navigator.userAgent,
                serviceWorkerSupport: 'serviceWorker' in navigator,
                displayMode: window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser',
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                screen: `${screen.width}x${screen.height}`,
                pixelRatio: window.devicePixelRatio,
                online: navigator.onLine,
                cookieEnabled: navigator.cookieEnabled,
                language: navigator.language,
                languages: navigator.languages,
                platform: navigator.platform,
                hardwareConcurrency: navigator.hardwareConcurrency,
                maxTouchPoints: navigator.maxTouchPoints,
                manifestData: manifestData
            };

            document.getElementById('detailed-info').textContent = JSON.stringify(info, null, 2);
        }

        // ç›£è½ beforeinstallprompt äº‹ä»¶
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('ğŸ’¡ PWA å®‰è£æç¤ºå¯ç”¨', e);
            
            const checks = document.getElementById('install-checks');
            checks.innerHTML += `<div class="status success">âœ… å®‰è£æç¤ºäº‹ä»¶å·²è§¸ç™¼</div>`;
            document.getElementById('install-btn').disabled = false;
        });

        // ç›£è½å®‰è£å®Œæˆäº‹ä»¶
        window.addEventListener('appinstalled', (e) => {
            console.log('ğŸ‰ PWA å®‰è£å®Œæˆ', e);
            const checks = document.getElementById('install-checks');
            checks.innerHTML += `<div class="status success">ğŸ‰ PWA å®‰è£å®Œæˆ</div>`;
        });

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œæª¢æŸ¥
        window.addEventListener('load', () => {
            performBasicChecks();
            testManifest();
            testServiceWorker();
            checkInstallability();
            refreshInfo();
        });
    </script>
</body>
</html> 