<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA å¤šèªè¨€æ¸¬è©¦ - LingUBible</title>
    <link rel="manifest" href="/manifest-dynamic.json" id="manifest-link">
    <meta name="theme-color" content="#dc2626">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #b91c1c; }
        .current-lang {
            background: #059669;
            font-weight: bold;
        }
        .manifest-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #dc2626;
        }
        .install-prompt {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸŒ PWA å¤šèªè¨€æ¸¬è©¦</h1>
    <p>é€™å€‹é é¢æ¸¬è©¦ PWA manifest çš„å¤šèªè¨€åŠŸèƒ½ã€‚åˆ‡æ›èªè¨€å¾Œï¼ŒPWA å®‰è£æç¤ºçš„åç¨±å’Œæè¿°æœƒç›¸æ‡‰æ”¹è®Šã€‚</p>

    <h2>ğŸ”„ èªè¨€åˆ‡æ›</h2>
    <button onclick="setLanguage('en')" id="btn-en">English</button>
    <button onclick="setLanguage('zh-TW')" id="btn-zh-TW" class="current-lang">ç¹é«”ä¸­æ–‡</button>
    <button onclick="setLanguage('zh-CN')" id="btn-zh-CN">ç®€ä½“ä¸­æ–‡</button>

    <div class="manifest-info">
        <h3>ğŸ“‹ ç•¶å‰ Manifest ä¿¡æ¯</h3>
        <div id="manifest-info">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="install-prompt" id="install-section" style="display: none;">
        <h3>ğŸ“± PWA å®‰è£æç¤º</h3>
        <p>ç€è¦½å™¨æª¢æ¸¬åˆ°å¯å®‰è£çš„ PWAï¼</p>
        <button id="install-btn">å®‰è£æ‡‰ç”¨</button>
        <button onclick="showInstallInstructions()">é¡¯ç¤ºå®‰è£æŒ‡å¼•</button>
    </div>

    <h2>ğŸ§ª æ¸¬è©¦åŠŸèƒ½</h2>
    <button onclick="refreshManifest()">é‡æ–°è¼‰å…¥ Manifest</button>
    <button onclick="triggerInstallPrompt()">è§¸ç™¼å®‰è£æç¤º</button>
    <button onclick="checkPWAStatus()">æª¢æŸ¥ PWA ç‹€æ…‹</button>

    <div id="log" style="margin-top: 20px; font-family: monospace; font-size: 12px; background: #f1f1f1; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;"></div>

    <script>
        let deferredPrompt;
        let currentLanguage = 'zh-TW';

        // æ—¥èªŒå‡½æ•¸
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // è¨­ç½®èªè¨€
        function setLanguage(lang) {
            currentLanguage = lang;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('button[id^="btn-"]').forEach(btn => {
                btn.classList.remove('current-lang');
            });
            document.getElementById(`btn-${lang}`).classList.add('current-lang');
            
            // è¨­ç½® Cookie
            document.cookie = `language=${lang}; path=/; max-age=31536000`;
            
            // æ›´æ–° manifest
            updateManifest();
            
            log(`ğŸŒ èªè¨€å·²åˆ‡æ›åˆ°: ${lang}`);
        }

        // æ›´æ–° manifest
        function updateManifest() {
            const manifestLink = document.getElementById('manifest-link');
            const newHref = `/manifest-dynamic.json?lang=${currentLanguage}&v=${Date.now()}`;
            manifestLink.href = newHref;
            
            log(`ğŸ“‹ Manifest å·²æ›´æ–°: ${newHref}`);
            
            // è¼‰å…¥ä¸¦é¡¯ç¤º manifest ä¿¡æ¯
            loadManifestInfo();
        }

        // è¼‰å…¥ manifest ä¿¡æ¯
        async function loadManifestInfo() {
            try {
                const response = await fetch(`/manifest-dynamic.json?lang=${currentLanguage}&v=${Date.now()}`);
                const manifest = await response.json();
                
                const infoDiv = document.getElementById('manifest-info');
                infoDiv.innerHTML = `
                    <strong>åç¨±:</strong> ${manifest.name}<br>
                    <strong>ç°¡ç¨±:</strong> ${manifest.short_name}<br>
                    <strong>æè¿°:</strong> ${manifest.description}<br>
                    <strong>èªè¨€:</strong> ${manifest.lang || 'æœªè¨­ç½®'}<br>
                    <strong>åœ–æ¨™æ•¸é‡:</strong> ${manifest.icons ? manifest.icons.length : 0}
                `;
                
                log(`âœ… Manifest è¼‰å…¥æˆåŠŸ (${manifest.lang})`);
            } catch (error) {
                log(`âŒ Manifest è¼‰å…¥å¤±æ•—: ${error.message}`);
            }
        }

        // é‡æ–°è¼‰å…¥ manifest
        function refreshManifest() {
            updateManifest();
        }

        // è§¸ç™¼å®‰è£æç¤º
        function triggerInstallPrompt() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    log(`ğŸ‘¤ ç”¨æˆ¶é¸æ“‡: ${choiceResult.outcome}`);
                    deferredPrompt = null;
                });
            } else {
                log('âš ï¸ æ²’æœ‰å¯ç”¨çš„å®‰è£æç¤º');
            }
        }

        // æª¢æŸ¥ PWA ç‹€æ…‹
        function checkPWAStatus() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isInstalled = window.navigator.standalone === true;
            const hasServiceWorker = 'serviceWorker' in navigator;
            
            log(`ğŸ“± PWA ç‹€æ…‹æª¢æŸ¥:`);
            log(`   - ç¨ç«‹æ¨¡å¼: ${isStandalone ? 'æ˜¯' : 'å¦'}`);
            log(`   - å·²å®‰è£: ${isInstalled ? 'æ˜¯' : 'å¦'}`);
            log(`   - Service Worker æ”¯æ´: ${hasServiceWorker ? 'æ˜¯' : 'å¦'}`);
        }

        // é¡¯ç¤ºå®‰è£æŒ‡å¼•ï¼ˆå¤šèªè¨€ç‰ˆæœ¬ï¼‰
        function showInstallInstructions() {
            const instructions = getLocalizedInstructions();
            alert(`${instructions.title}ï¼š
1. ${instructions.step1}
2. ${instructions.step2}
3. ${instructions.step3}

${instructions.browserSpecific}ï¼š
â€¢ ${instructions.chrome}
â€¢ ${instructions.firefox}
â€¢ ${instructions.safari}
â€¢ ${instructions.edge}`);
        }

        // ç²å–æœ¬åœ°åŒ–çš„å®‰è£æŒ‡å¼•
        function getLocalizedInstructions() {
            const instructions = {
                'en': {
                    title: 'Installation Guide',
                    step1: 'Look for the install icon in the browser address bar',
                    step2: 'Or open browser menu and look for "Install app" option',
                    step3: 'Follow the prompts to complete installation',
                    browserSpecific: 'Browser-specific instructions',
                    chrome: 'Chrome: Menu â†’ Install app',
                    firefox: 'Firefox: Menu â†’ Install',
                    safari: 'Safari: Share â†’ Add to Home Screen',
                    edge: 'Edge: Menu â†’ Apps â†’ Install this site as an app'
                },
                'zh-TW': {
                    title: 'å®‰è£æŒ‡å¼•',
                    step1: 'åœ¨ç€è¦½å™¨åœ°å€æ¬„å³å´å°‹æ‰¾å®‰è£åœ–æ¨™',
                    step2: 'æˆ–è€…æ‰“é–‹ç€è¦½å™¨é¸å–®ï¼Œå°‹æ‰¾ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€é¸é …',
                    step3: 'æŒ‰ç…§æç¤ºå®Œæˆå®‰è£',
                    browserSpecific: 'ç€è¦½å™¨ç‰¹å®šæŒ‡å¼•',
                    chrome: 'Chromeï¼šé¸å–® â†’ å®‰è£æ‡‰ç”¨ç¨‹å¼',
                    firefox: 'Firefoxï¼šé¸å–® â†’ å®‰è£',
                    safari: 'Safariï¼šåˆ†äº« â†’ åŠ å…¥ä¸»ç•«é¢',
                    edge: 'Edgeï¼šé¸å–® â†’ æ‡‰ç”¨ç¨‹å¼ â†’ å°‡æ­¤ç¶²ç«™å®‰è£ç‚ºæ‡‰ç”¨ç¨‹å¼'
                },
                'zh-CN': {
                    title: 'å®‰è£…æŒ‡å¼•',
                    step1: 'åœ¨æµè§ˆå™¨åœ°å€æ å³ä¾§å¯»æ‰¾å®‰è£…å›¾æ ‡',
                    step2: 'æˆ–è€…æ‰“å¼€æµè§ˆå™¨èœå•ï¼Œå¯»æ‰¾ã€Œå®‰è£…åº”ç”¨ã€é€‰é¡¹',
                    step3: 'æŒ‰ç…§æç¤ºå®Œæˆå®‰è£…',
                    browserSpecific: 'æµè§ˆå™¨ç‰¹å®šæŒ‡å¼•',
                    chrome: 'Chromeï¼šèœå• â†’ å®‰è£…åº”ç”¨',
                    firefox: 'Firefoxï¼šèœå• â†’ å®‰è£…',
                    safari: 'Safariï¼šåˆ†äº« â†’ æ·»åŠ åˆ°ä¸»å±å¹•',
                    edge: 'Edgeï¼šèœå• â†’ åº”ç”¨ â†’ å°†æ­¤ç«™ç‚¹å®‰è£…ä¸ºåº”ç”¨'
                }
            };
            
            return instructions[currentLanguage] || instructions['en'];
        }

        // PWA äº‹ä»¶ç›£è½
        window.addEventListener('beforeinstallprompt', (e) => {
            log('ğŸ’¡ PWA å®‰è£æç¤ºå¯ç”¨');
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-section').style.display = 'block';
        });

        window.addEventListener('appinstalled', () => {
            log('ğŸ‰ PWA å®‰è£æˆåŠŸ');
            document.getElementById('install-section').style.display = 'none';
        });

        // å®‰è£æŒ‰éˆ•äº‹ä»¶
        document.getElementById('install-btn').addEventListener('click', triggerInstallPrompt);

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸš€ é é¢è¼‰å…¥å®Œæˆ');
            
            // æª¢æŸ¥ Cookie ä¸­çš„èªè¨€è¨­ç½®
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'language' && ['en', 'zh-TW', 'zh-CN'].includes(value)) {
                    currentLanguage = value;
                    break;
                }
            }
            
            setLanguage(currentLanguage);
            checkPWAStatus();
        });
    </script>
</body>
</html> 