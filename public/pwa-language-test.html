<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA 多語言測試 - LingUBible</title>
    <link rel="manifest" href="/manifest-dynamic.json" id="manifest-link">
    <meta name="theme-color" content="#dc2626">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #b91c1c; }
        .current-lang {
            background: #059669;
            font-weight: bold;
        }
        .manifest-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #dc2626;
        }
        .install-prompt {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🌐 PWA 多語言測試</h1>
    <p>這個頁面測試 PWA manifest 的多語言功能。切換語言後，PWA 安裝提示的名稱和描述會相應改變。</p>

    <h2>🔄 語言切換</h2>
    <button onclick="setLanguage('en')" id="btn-en">English</button>
    <button onclick="setLanguage('zh-TW')" id="btn-zh-TW" class="current-lang">繁體中文</button>
    <button onclick="setLanguage('zh-CN')" id="btn-zh-CN">简体中文</button>

    <div class="manifest-info">
        <h3>📋 當前 Manifest 信息</h3>
        <div id="manifest-info">載入中...</div>
    </div>

    <div class="install-prompt" id="install-section" style="display: none;">
        <h3>📱 PWA 安裝提示</h3>
        <p>瀏覽器檢測到可安裝的 PWA！</p>
        <button id="install-btn">安裝應用</button>
        <button onclick="showInstallInstructions()">顯示安裝指引</button>
    </div>

    <h2>🧪 測試功能</h2>
    <button onclick="refreshManifest()">重新載入 Manifest</button>
    <button onclick="triggerInstallPrompt()">觸發安裝提示</button>
    <button onclick="checkPWAStatus()">檢查 PWA 狀態</button>

    <div id="log" style="margin-top: 20px; font-family: monospace; font-size: 12px; background: #f1f1f1; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;"></div>

    <script>
        let deferredPrompt;
        let currentLanguage = 'zh-TW';

        // 日誌函數
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // 設置語言
        function setLanguage(lang) {
            currentLanguage = lang;
            
            // 更新按鈕樣式
            document.querySelectorAll('button[id^="btn-"]').forEach(btn => {
                btn.classList.remove('current-lang');
            });
            document.getElementById(`btn-${lang}`).classList.add('current-lang');
            
            // 設置 Cookie
            document.cookie = `language=${lang}; path=/; max-age=31536000`;
            
            // 更新 manifest
            updateManifest();
            
            log(`🌐 語言已切換到: ${lang}`);
        }

        // 更新 manifest
        function updateManifest() {
            const manifestLink = document.getElementById('manifest-link');
            const newHref = `/manifest-dynamic.json?lang=${currentLanguage}&v=${Date.now()}`;
            manifestLink.href = newHref;
            
            log(`📋 Manifest 已更新: ${newHref}`);
            
            // 載入並顯示 manifest 信息
            loadManifestInfo();
        }

        // 載入 manifest 信息
        async function loadManifestInfo() {
            try {
                const response = await fetch(`/manifest-dynamic.json?lang=${currentLanguage}&v=${Date.now()}`);
                const manifest = await response.json();
                
                const infoDiv = document.getElementById('manifest-info');
                infoDiv.innerHTML = `
                    <strong>名稱:</strong> ${manifest.name}<br>
                    <strong>簡稱:</strong> ${manifest.short_name}<br>
                    <strong>描述:</strong> ${manifest.description}<br>
                    <strong>語言:</strong> ${manifest.lang || '未設置'}<br>
                    <strong>圖標數量:</strong> ${manifest.icons ? manifest.icons.length : 0}
                `;
                
                log(`✅ Manifest 載入成功 (${manifest.lang})`);
            } catch (error) {
                log(`❌ Manifest 載入失敗: ${error.message}`);
            }
        }

        // 重新載入 manifest
        function refreshManifest() {
            updateManifest();
        }

        // 觸發安裝提示
        function triggerInstallPrompt() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    log(`👤 用戶選擇: ${choiceResult.outcome}`);
                    deferredPrompt = null;
                });
            } else {
                log('⚠️ 沒有可用的安裝提示');
            }
        }

        // 檢查 PWA 狀態
        function checkPWAStatus() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isInstalled = window.navigator.standalone === true;
            const hasServiceWorker = 'serviceWorker' in navigator;
            
            log(`📱 PWA 狀態檢查:`);
            log(`   - 獨立模式: ${isStandalone ? '是' : '否'}`);
            log(`   - 已安裝: ${isInstalled ? '是' : '否'}`);
            log(`   - Service Worker 支援: ${hasServiceWorker ? '是' : '否'}`);
        }

        // 顯示安裝指引（多語言版本）
        function showInstallInstructions() {
            const instructions = getLocalizedInstructions();
            alert(`${instructions.title}：
1. ${instructions.step1}
2. ${instructions.step2}
3. ${instructions.step3}

${instructions.browserSpecific}：
• ${instructions.chrome}
• ${instructions.firefox}
• ${instructions.safari}
• ${instructions.edge}`);
        }

        // 獲取本地化的安裝指引
        function getLocalizedInstructions() {
            const instructions = {
                'en': {
                    title: 'Installation Guide',
                    step1: 'Look for the install icon in the browser address bar',
                    step2: 'Or open browser menu and look for "Install app" option',
                    step3: 'Follow the prompts to complete installation',
                    browserSpecific: 'Browser-specific instructions',
                    chrome: 'Chrome: Menu → Install app',
                    firefox: 'Firefox: Menu → Install',
                    safari: 'Safari: Share → Add to Home Screen',
                    edge: 'Edge: Menu → Apps → Install this site as an app'
                },
                'zh-TW': {
                    title: '安裝指引',
                    step1: '在瀏覽器地址欄右側尋找安裝圖標',
                    step2: '或者打開瀏覽器選單，尋找「安裝應用程式」選項',
                    step3: '按照提示完成安裝',
                    browserSpecific: '瀏覽器特定指引',
                    chrome: 'Chrome：選單 → 安裝應用程式',
                    firefox: 'Firefox：選單 → 安裝',
                    safari: 'Safari：分享 → 加入主畫面',
                    edge: 'Edge：選單 → 應用程式 → 將此網站安裝為應用程式'
                },
                'zh-CN': {
                    title: '安装指引',
                    step1: '在浏览器地址栏右侧寻找安装图标',
                    step2: '或者打开浏览器菜单，寻找「安装应用」选项',
                    step3: '按照提示完成安装',
                    browserSpecific: '浏览器特定指引',
                    chrome: 'Chrome：菜单 → 安装应用',
                    firefox: 'Firefox：菜单 → 安装',
                    safari: 'Safari：分享 → 添加到主屏幕',
                    edge: 'Edge：菜单 → 应用 → 将此站点安装为应用'
                }
            };
            
            return instructions[currentLanguage] || instructions['en'];
        }

        // PWA 事件監聽
        window.addEventListener('beforeinstallprompt', (e) => {
            log('💡 PWA 安裝提示可用');
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-section').style.display = 'block';
        });

        window.addEventListener('appinstalled', () => {
            log('🎉 PWA 安裝成功');
            document.getElementById('install-section').style.display = 'none';
        });

        // 安裝按鈕事件
        document.getElementById('install-btn').addEventListener('click', triggerInstallPrompt);

        // 頁面載入時初始化
        window.addEventListener('load', () => {
            log('🚀 頁面載入完成');
            
            // 檢查 Cookie 中的語言設置
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'language' && ['en', 'zh-TW', 'zh-CN'].includes(value)) {
                    currentLanguage = value;
                    break;
                }
            }
            
            setLanguage(currentLanguage);
            checkPWAStatus();
        });
    </script>
</body>
</html> 