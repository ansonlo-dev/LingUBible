<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨ç½²ä¿®å¾©æ¸¬è©¦ - LingUBible</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #1e293b;
            margin-bottom: 24px;
            border-bottom: 2px solid #dc2626;
            padding-bottom: 12px;
        }
        h2 {
            color: #374151;
            margin-top: 32px;
            margin-bottom: 16px;
        }
        .test-item {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .test-item h3 {
            margin: 0 0 8px 0;
            color: #1e293b;
        }
        .test-item p {
            margin: 0 0 12px 0;
            color: #64748b;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        .status.success {
            background: #dcfce7;
            color: #166534;
        }
        .status.error {
            background: #fef2f2;
            color: #dc2626;
        }
        .status.warning {
            background: #fef3c7;
            color: #d97706;
        }
        .status.info {
            background: #dbeafe;
            color: #2563eb;
        }
        button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        button:hover {
            background: #b91c1c;
        }
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .link-test {
            display: block;
            color: #2563eb;
            text-decoration: none;
            padding: 8px 12px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .link-test:hover {
            background: #e0f2fe;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ éƒ¨ç½²ä¿®å¾©æ¸¬è©¦</h1>
        <p>æ­¤é é¢ç”¨æ–¼æ¸¬è©¦éƒ¨ç½²ç›¸é—œå•é¡Œçš„ä¿®å¾©æ•ˆæœã€‚</p>
        
        <h2>ğŸ“„ éœæ…‹æ–‡ä»¶è¨ªå•æ¸¬è©¦</h2>
        <div class="test-item">
            <h3>HTML æ–‡ä»¶ç›´æ¥è¨ªå•</h3>
            <p>æ¸¬è©¦ .html å¾Œç¶´æ˜¯å¦è¢«æ­£ç¢ºè™•ç†</p>
            <div id="html-access-status" class="status info">æ¸¬è©¦ä¸­...</div>
            <br><br>
            <a href="/pwa-install-debug.html" class="link-test" target="_blank">
                ğŸ“± PWA å®‰è£èª¿è©¦é é¢ (.html)
            </a>
            <a href="/pwa-engagement-test.html" class="link-test" target="_blank">
                ğŸ¯ PWA åƒèˆ‡åº¦æ¸¬è©¦é é¢ (.html)
            </a>
            <a href="/test-console-errors.html" class="link-test" target="_blank">
                ğŸ› æ§åˆ¶å°éŒ¯èª¤æ¸¬è©¦é é¢ (.html)
            </a>
        </div>

        <h2>ğŸ”„ ç‰ˆæœ¬æª¢æ¸¬å’Œç·©å­˜æ¸…ç†æ¸¬è©¦</h2>
        <div class="test-item">
            <h3>ç•¶å‰ç‰ˆæœ¬ä¿¡æ¯</h3>
            <p>æª¢æŸ¥ç‰ˆæœ¬æª¢æ¸¬æ©Ÿåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
            <div id="version-info" class="status info">è¼‰å…¥ä¸­...</div>
            <br><br>
            <button onclick="checkVersion()">ğŸ” æª¢æŸ¥ç‰ˆæœ¬</button>
            <button onclick="simulateVersionUpdate()">ğŸ†• æ¨¡æ“¬ç‰ˆæœ¬æ›´æ–°</button>
            <button onclick="clearAllCaches()">ğŸ—‘ï¸ æ¸…ç†æ‰€æœ‰ç·©å­˜</button>
        </div>

        <div class="test-item">
            <h3>Service Worker ç‹€æ…‹</h3>
            <p>æª¢æŸ¥ Service Worker è¨»å†Šå’Œæ›´æ–°ç‹€æ…‹</p>
            <div id="sw-status" class="status info">æª¢æŸ¥ä¸­...</div>
            <br><br>
            <button onclick="checkServiceWorker()">ğŸ”„ æª¢æŸ¥ SW ç‹€æ…‹</button>
            <button onclick="updateServiceWorker()">â¬†ï¸ å¼·åˆ¶æ›´æ–° SW</button>
        </div>

        <h2>ğŸ“Š ç·©å­˜ç‹€æ…‹æª¢æŸ¥</h2>
        <div class="test-item">
            <h3>ç€è¦½å™¨ç·©å­˜</h3>
            <div id="cache-info" class="status info">æª¢æŸ¥ä¸­...</div>
            <br><br>
            <button onclick="listCaches()">ğŸ“‹ åˆ—å‡ºæ‰€æœ‰ç·©å­˜</button>
            <button onclick="checkCacheSize()">ğŸ“ æª¢æŸ¥ç·©å­˜å¤§å°</button>
        </div>

        <h2>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h2>
        <div id="test-log" class="log">ç­‰å¾…æ¸¬è©¦é–‹å§‹...\n</div>
        <button onclick="clearLog()">ğŸ§¹ æ¸…ç†æ—¥èªŒ</button>
        <button onclick="exportLog()">ğŸ’¾ å°å‡ºæ—¥èªŒ</button>
    </div>

    <script>
        let testLog = '';

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            testLog += logMessage + '\n';
            document.getElementById('test-log').textContent = testLog;
            console.log(logMessage);
        }

        function updateStatus(elementId, status, className) {
            const element = document.getElementById(elementId);
            element.textContent = status;
            element.className = `status ${className}`;
        }

        // åˆå§‹åŒ–æ¸¬è©¦
        window.addEventListener('load', function() {
            log('ğŸš€ éƒ¨ç½²ä¿®å¾©æ¸¬è©¦é–‹å§‹');
            checkVersion();
            checkServiceWorker();
            listCaches();
            testHtmlAccess();
        });

        function checkVersion() {
            const currentVersion = localStorage.getItem('app_version') || 'æœªçŸ¥';
            const packageVersion = '0.1.8'; // å¾ package.json åŒæ­¥
            
            log(`ğŸ“¦ Package.json ç‰ˆæœ¬: ${packageVersion}`);
            log(`ğŸ’¾ æœ¬åœ°å­˜å„²ç‰ˆæœ¬: ${currentVersion}`);
            
            if (currentVersion === packageVersion) {
                updateStatus('version-info', `ç‰ˆæœ¬ä¸€è‡´: ${currentVersion}`, 'success');
            } else {
                updateStatus('version-info', `ç‰ˆæœ¬ä¸ä¸€è‡´: æœ¬åœ° ${currentVersion} vs åŒ… ${packageVersion}`, 'warning');
            }
        }

        function simulateVersionUpdate() {
            log('ğŸ”„ æ¨¡æ“¬ç‰ˆæœ¬æ›´æ–°...');
            localStorage.setItem('app_version', '0.1.7'); // è¨­ç½®èˆŠç‰ˆæœ¬
            log('âœ… å·²è¨­ç½®èˆŠç‰ˆæœ¬è™Ÿï¼Œåˆ·æ–°é é¢å°‡è§¸ç™¼æ›´æ–°');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        async function clearAllCaches() {
            log('ğŸ—‘ï¸ é–‹å§‹æ¸…ç†æ‰€æœ‰ç·©å­˜...');
            
            try {
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    log(`ğŸ“‹ æ‰¾åˆ° ${cacheNames.length} å€‹ç·©å­˜`);
                    
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        log(`ğŸ—‘ï¸ å·²åˆªé™¤ç·©å­˜: ${cacheName}`);
                    }
                }
                
                // æ¸…ç† localStorageï¼ˆä¿ç•™é‡è¦æ•¸æ“šï¼‰
                const importantKeys = ['user_session', 'auth_token', 'user_preferences'];
                const backupData = {};
                importantKeys.forEach(key => {
                    if (localStorage.getItem(key)) {
                        backupData[key] = localStorage.getItem(key);
                    }
                });
                
                localStorage.clear();
                
                Object.keys(backupData).forEach(key => {
                    localStorage.setItem(key, backupData[key]);
                });
                
                log('âœ… ç·©å­˜æ¸…ç†å®Œæˆ');
                updateStatus('cache-info', 'ç·©å­˜å·²æ¸…ç†', 'success');
                
            } catch (error) {
                log(`âŒ æ¸…ç†ç·©å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                updateStatus('cache-info', 'æ¸…ç†å¤±æ•—', 'error');
            }
        }

        function checkServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    if (registration) {
                        log('âœ… Service Worker å·²è¨»å†Š');
                        log(`ğŸ“„ SW è…³æœ¬: ${registration.scope}`);
                        log(`ğŸ”„ ç‹€æ…‹: ${registration.active ? 'æ´»èº' : 'æœªæ´»èº'}`);
                        updateStatus('sw-status', 'Service Worker æ­£å¸¸', 'success');
                    } else {
                        log('âš ï¸ Service Worker æœªè¨»å†Š');
                        updateStatus('sw-status', 'SW æœªè¨»å†Š', 'warning');
                    }
                }).catch(error => {
                    log(`âŒ æª¢æŸ¥ Service Worker æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                    updateStatus('sw-status', 'SW æª¢æŸ¥å¤±æ•—', 'error');
                });
            } else {
                log('âŒ ç€è¦½å™¨ä¸æ”¯æ´ Service Worker');
                updateStatus('sw-status', 'ä¸æ”¯æ´ SW', 'error');
            }
        }

        function updateServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    if (registration) {
                        log('ğŸ”„ å¼·åˆ¶æ›´æ–° Service Worker...');
                        registration.update().then(() => {
                            log('âœ… Service Worker æ›´æ–°å®Œæˆ');
                        }).catch(error => {
                            log(`âŒ æ›´æ–° Service Worker å¤±æ•—: ${error.message}`);
                        });
                    } else {
                        log('âš ï¸ æ²’æœ‰æ‰¾åˆ° Service Worker è¨»å†Š');
                    }
                });
            }
        }

        async function listCaches() {
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    log(`ğŸ“‹ æ‰¾åˆ° ${cacheNames.length} å€‹ç·©å­˜:`);
                    
                    for (const cacheName of cacheNames) {
                        const cache = await caches.open(cacheName);
                        const keys = await cache.keys();
                        log(`  - ${cacheName}: ${keys.length} å€‹é …ç›®`);
                    }
                    
                    updateStatus('cache-info', `${cacheNames.length} å€‹ç·©å­˜`, 'info');
                } catch (error) {
                    log(`âŒ åˆ—å‡ºç·©å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                    updateStatus('cache-info', 'æª¢æŸ¥å¤±æ•—', 'error');
                }
            } else {
                log('âŒ ç€è¦½å™¨ä¸æ”¯æ´ Cache API');
                updateStatus('cache-info', 'ä¸æ”¯æ´ç·©å­˜', 'error');
            }
        }

        async function checkCacheSize() {
            if ('caches' in window && 'storage' in navigator && 'estimate' in navigator.storage) {
                try {
                    const estimate = await navigator.storage.estimate();
                    const usedMB = (estimate.usage / 1024 / 1024).toFixed(2);
                    const quotaMB = (estimate.quota / 1024 / 1024).toFixed(2);
                    
                    log(`ğŸ’¾ å­˜å„²ä½¿ç”¨é‡: ${usedMB} MB / ${quotaMB} MB`);
                    updateStatus('cache-info', `ä½¿ç”¨ ${usedMB} MB`, 'info');
                } catch (error) {
                    log(`âŒ æª¢æŸ¥å­˜å„²å¤§å°æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                }
            } else {
                log('âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´å­˜å„²ä¼°ç®— API');
            }
        }

        function testHtmlAccess() {
            // æ¸¬è©¦ HTML æ–‡ä»¶æ˜¯å¦å¯ä»¥ç›´æ¥è¨ªå•
            const testUrls = [
                '/pwa-install-debug.html',
                '/pwa-engagement-test.html',
                '/test-console-errors.html'
            ];

            let successCount = 0;
            let totalTests = testUrls.length;

            testUrls.forEach(url => {
                fetch(url, { method: 'HEAD' })
                    .then(response => {
                        if (response.ok) {
                            log(`âœ… HTML æ–‡ä»¶å¯è¨ªå•: ${url}`);
                            successCount++;
                        } else {
                            log(`âŒ HTML æ–‡ä»¶è¨ªå•å¤±æ•—: ${url} (${response.status})`);
                        }
                        
                        if (successCount === totalTests) {
                            updateStatus('html-access-status', 'æ‰€æœ‰ HTML æ–‡ä»¶æ­£å¸¸', 'success');
                        } else if (successCount > 0) {
                            updateStatus('html-access-status', `${successCount}/${totalTests} æ–‡ä»¶æ­£å¸¸`, 'warning');
                        } else {
                            updateStatus('html-access-status', 'HTML æ–‡ä»¶è¨ªå•å¤±æ•—', 'error');
                        }
                    })
                    .catch(error => {
                        log(`âŒ æ¸¬è©¦ HTML æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ${url} - ${error.message}`);
                    });
            });
        }

        function clearLog() {
            testLog = '';
            document.getElementById('test-log').textContent = 'æ—¥èªŒå·²æ¸…ç†\n';
        }

        function exportLog() {
            const blob = new Blob([testLog], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `deployment-test-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            log('ğŸ’¾ æ¸¬è©¦æ—¥èªŒå·²å°å‡º');
        }
    </script>
</body>
</html> 