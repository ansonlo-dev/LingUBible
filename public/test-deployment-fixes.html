<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 部署修復測試 - LingUBible</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .test-section h2 {
            margin-top: 0;
            color: #fff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .status.success {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
        }
        .status.warning {
            background: rgba(255, 193, 7, 0.3);
            border: 1px solid #FFC107;
        }
        .status.error {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #F44336;
        }
        .status.info {
            background: rgba(33, 150, 243, 0.3);
            border: 1px solid #2196F3;
        }
        button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .pwa-install-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .metric {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
        }
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4CAF50;
        }
        .metric-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
        .version-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .version-info h3 {
            margin-top: 0;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 部署修復測試工具</h1>
        <p style="text-align: center; opacity: 0.9;">測試版本檢測、緩存清理和 PWA 安裝功能</p>

        <div class="test-grid">
            <!-- 版本檢測測試 -->
            <div class="test-section">
                <h2>📦 版本檢測測試</h2>
                <div id="version-status"></div>
                <button onclick="testVersionDetection()">檢測版本</button>
                <button onclick="simulateVersionUpdate()">模擬版本更新</button>
                <button onclick="clearVersionData()">清除版本數據</button>
                <div class="version-info">
                    <h3>版本信息</h3>
                    <div id="version-details"></div>
                </div>
            </div>

            <!-- 緩存測試 -->
            <div class="test-section">
                <h2>🗄️ 緩存管理測試</h2>
                <div id="cache-status"></div>
                <button onclick="testCacheStatus()">檢查緩存</button>
                <button onclick="forceClearCache()">強制清理緩存</button>
                <button onclick="testCacheClearing()">測試緩存清理</button>
                <div id="cache-details"></div>
            </div>

            <!-- PWA 安裝測試 -->
            <div class="test-section">
                <h2>📱 PWA 安裝測試</h2>
                <div id="pwa-status"></div>
                <button onclick="testPWAInstall()" class="pwa-install-button">測試 PWA 安裝</button>
                <button onclick="checkPWAStatus()">檢查 PWA 狀態</button>
                <button onclick="simulateUserInteraction()">模擬用戶互動</button>
                <div id="pwa-details"></div>
            </div>

            <!-- Service Worker 測試 -->
            <div class="test-section">
                <h2>⚙️ Service Worker 測試</h2>
                <div id="sw-status"></div>
                <button onclick="testServiceWorker()">檢查 SW</button>
                <button onclick="updateServiceWorker()">更新 SW</button>
                <button onclick="unregisterServiceWorker()">註銷 SW</button>
                <div id="sw-details"></div>
            </div>
        </div>

        <!-- 實時日誌 -->
        <div class="test-section">
            <h2>📋 實時日誌</h2>
            <button onclick="clearLog()">清除日誌</button>
            <button onclick="exportLog()">導出日誌</button>
            <div id="log" class="log"></div>
        </div>

        <!-- 系統信息 -->
        <div class="test-section">
            <h2>💻 系統信息</h2>
            <div id="system-info"></div>
            <button onclick="refreshSystemInfo()">刷新信息</button>
        </div>
    </div>

    <script>
        let logEntries = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            logEntries.push(entry);
            
            const logElement = document.getElementById('log');
            logElement.textContent = logEntries.slice(-50).join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(message);
        }

        function clearLog() {
            logEntries = [];
            document.getElementById('log').textContent = '';
        }

        function exportLog() {
            const logText = logEntries.join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lingubible-test-log-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 版本檢測測試
        function testVersionDetection() {
            log('🔍 開始版本檢測測試...');
            
            const currentVersion = localStorage.getItem('app_version');
            const cacheCleared = localStorage.getItem('cache_cleared_for_version');
            const swVersion = window.PWAInstaller?.getVersion();
            
            const status = document.getElementById('version-status');
            const details = document.getElementById('version-details');
            
            let html = '';
            if (currentVersion) {
                html += `<div class="status success">✅ 當前版本: ${currentVersion}</div>`;
            } else {
                html += `<div class="status warning">⚠️ 未找到版本信息</div>`;
            }
            
            if (cacheCleared) {
                html += `<div class="status info">🧹 緩存清理版本: ${cacheCleared}</div>`;
            }
            
            if (swVersion) {
                html += `<div class="status info">⚙️ Service Worker 版本: ${swVersion}</div>`;
            }
            
            status.innerHTML = html;
            
            details.innerHTML = `
                <p><strong>localStorage 版本:</strong> ${currentVersion || '未設置'}</p>
                <p><strong>緩存清理標記:</strong> ${cacheCleared || '未設置'}</p>
                <p><strong>SW 版本:</strong> ${swVersion || '未知'}</p>
                <p><strong>版本一致性:</strong> ${currentVersion === swVersion ? '✅ 一致' : '❌ 不一致'}</p>
            `;
            
            log(`版本檢測完成: localStorage=${currentVersion}, SW=${swVersion}`);
        }

        function simulateVersionUpdate() {
            log('🔄 模擬版本更新...');
            
            // 設置一個舊版本
            const oldVersion = '0.1.16';
            localStorage.setItem('app_version', oldVersion);
            localStorage.removeItem('cache_cleared_for_version');
            
            log(`設置舊版本: ${oldVersion}`);
            
            // 重新載入頁面觸發版本檢測
            setTimeout(() => {
                log('重新載入頁面以觸發版本檢測...');
                window.location.reload();
            }, 1000);
        }

        function clearVersionData() {
            log('🗑️ 清除版本數據...');
            
            localStorage.removeItem('app_version');
            localStorage.removeItem('cache_cleared_for_version');
            
            log('版本數據已清除');
            testVersionDetection();
        }

        // 緩存測試
        async function testCacheStatus() {
            log('🗄️ 檢查緩存狀態...');
            
            const status = document.getElementById('cache-status');
            const details = document.getElementById('cache-details');
            
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    
                    let html = `<div class="status success">✅ 找到 ${cacheNames.length} 個緩存</div>`;
                    status.innerHTML = html;
                    
                    let detailsHtml = '<h4>緩存詳情:</h4>';
                    for (const cacheName of cacheNames) {
                        const cache = await caches.open(cacheName);
                        const keys = await cache.keys();
                        detailsHtml += `<p><strong>${cacheName}:</strong> ${keys.length} 個項目</p>`;
                    }
                    details.innerHTML = detailsHtml;
                    
                    log(`找到 ${cacheNames.length} 個緩存: ${cacheNames.join(', ')}`);
                } catch (error) {
                    status.innerHTML = `<div class="status error">❌ 緩存檢查失敗: ${error.message}</div>`;
                    log(`緩存檢查失敗: ${error.message}`);
                }
            } else {
                status.innerHTML = `<div class="status warning">⚠️ 瀏覽器不支援 Cache API</div>`;
                log('瀏覽器不支援 Cache API');
            }
        }

        async function forceClearCache() {
            log('🧹 強制清理所有緩存...');
            
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    
                    log(`已清理 ${cacheNames.length} 個緩存`);
                    testCacheStatus();
                } catch (error) {
                    log(`清理緩存失敗: ${error.message}`);
                }
            } else {
                log('瀏覽器不支援 Cache API');
            }
        }

        function testCacheClearing() {
            log('🧪 測試緩存清理邏輯...');
            
            // 模擬版本更新觸發緩存清理
            const currentVersion = localStorage.getItem('app_version');
            if (currentVersion) {
                localStorage.setItem('app_version', '0.1.16'); // 設置舊版本
                localStorage.removeItem('cache_cleared_for_version');
                
                log('已設置舊版本，重新載入頁面將觸發緩存清理');
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                log('未找到當前版本，無法測試');
            }
        }

        // PWA 安裝測試
        function testPWAInstall() {
            log('📱 測試 PWA 安裝功能...');
            
            const status = document.getElementById('pwa-status');
            const details = document.getElementById('pwa-details');
            
            // 檢查 PWA 安裝狀態
            const isPWAMode = window.matchMedia('(display-mode: standalone)').matches ||
                             window.navigator.standalone === true;
            
            const hasPrompt = window.PWAInstaller?.hasPrompt();
            const hasEngagement = window.PWAInstaller?.hasUserEngagement();
            
            let html = '';
            if (isPWAMode) {
                html += `<div class="status success">✅ 已在 PWA 模式下運行</div>`;
            } else if (hasPrompt) {
                html += `<div class="status success">✅ PWA 安裝提示可用</div>`;
            } else {
                html += `<div class="status warning">⚠️ PWA 安裝提示不可用</div>`;
            }
            
            status.innerHTML = html;
            
            details.innerHTML = `
                <p><strong>PWA 模式:</strong> ${isPWAMode ? '✅ 是' : '❌ 否'}</p>
                <p><strong>安裝提示:</strong> ${hasPrompt ? '✅ 可用' : '❌ 不可用'}</p>
                <p><strong>用戶互動:</strong> ${hasEngagement ? '✅ 充足' : '❌ 不足'}</p>
                <p><strong>瀏覽器:</strong> ${navigator.userAgent.split(' ').pop()}</p>
            `;
            
            // 嘗試觸發安裝
            if (hasPrompt && !isPWAMode) {
                log('嘗試觸發 PWA 安裝提示...');
                window.PWAInstaller?.triggerInstallPrompt();
            } else if (isPWAMode) {
                log('應用已在 PWA 模式下運行');
            } else {
                log('PWA 安裝提示不可用，顯示手動安裝指引');
                window.PWAInstaller?.showManualInstructions();
            }
        }

        function checkPWAStatus() {
            log('🔍 檢查 PWA 狀態...');
            
            const status = document.getElementById('pwa-status');
            const details = document.getElementById('pwa-details');
            
            const isPWAMode = window.PWAInstaller?.isPWAMode();
            const hasPrompt = window.PWAInstaller?.hasPrompt();
            const hasEngagement = window.PWAInstaller?.hasUserEngagement();
            
            let html = `<div class="status info">📊 PWA 狀態檢查完成</div>`;
            status.innerHTML = html;
            
            details.innerHTML = `
                <h4>PWA 狀態詳情:</h4>
                <p><strong>PWA 模式:</strong> ${isPWAMode}</p>
                <p><strong>安裝提示:</strong> ${hasPrompt}</p>
                <p><strong>用戶互動:</strong> ${hasEngagement}</p>
                <p><strong>顯示模式:</strong> ${window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser'}</p>
                <p><strong>平台:</strong> ${navigator.platform}</p>
                <p><strong>用戶代理:</strong> ${navigator.userAgent}</p>
            `;
            
            log(`PWA 狀態: 模式=${isPWAMode}, 提示=${hasPrompt}, 互動=${hasEngagement}`);
        }

        function simulateUserInteraction() {
            log('👤 模擬用戶互動...');
            
            // 觸發點擊事件
            document.body.click();
            
            // 觸發滾動事件
            window.scrollBy(0, 1);
            
            // 觸發鍵盤事件
            const keyEvent = new KeyboardEvent('keydown', { key: 'Space' });
            document.dispatchEvent(keyEvent);
            
            log('已模擬用戶互動（點擊、滾動、鍵盤）');
            
            setTimeout(() => {
                checkPWAStatus();
            }, 1000);
        }

        // Service Worker 測試
        async function testServiceWorker() {
            log('⚙️ 檢查 Service Worker 狀態...');
            
            const status = document.getElementById('sw-status');
            const details = document.getElementById('sw-details');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    
                    if (registration) {
                        const sw = registration.active || registration.installing || registration.waiting;
                        
                        let html = `<div class="status success">✅ Service Worker 已註冊</div>`;
                        status.innerHTML = html;
                        
                        details.innerHTML = `
                            <h4>Service Worker 詳情:</h4>
                            <p><strong>狀態:</strong> ${sw?.state || '未知'}</p>
                            <p><strong>腳本 URL:</strong> ${sw?.scriptURL || '未知'}</p>
                            <p><strong>範圍:</strong> ${registration.scope}</p>
                            <p><strong>更新時間:</strong> ${registration.updateViaCache}</p>
                        `;
                        
                        log(`Service Worker 已註冊: ${sw?.state}`);
                    } else {
                        status.innerHTML = `<div class="status warning">⚠️ Service Worker 未註冊</div>`;
                        log('Service Worker 未註冊');
                    }
                } catch (error) {
                    status.innerHTML = `<div class="status error">❌ Service Worker 檢查失敗: ${error.message}</div>`;
                    log(`Service Worker 檢查失敗: ${error.message}`);
                }
            } else {
                status.innerHTML = `<div class="status error">❌ 瀏覽器不支援 Service Worker</div>`;
                log('瀏覽器不支援 Service Worker');
            }
        }

        async function updateServiceWorker() {
            log('🔄 更新 Service Worker...');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        await registration.update();
                        log('Service Worker 更新請求已發送');
                    } else {
                        log('未找到 Service Worker 註冊');
                    }
                } catch (error) {
                    log(`Service Worker 更新失敗: ${error.message}`);
                }
            }
        }

        async function unregisterServiceWorker() {
            log('🗑️ 註銷 Service Worker...');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        await registration.unregister();
                        log('Service Worker 已註銷');
                        testServiceWorker();
                    } else {
                        log('未找到 Service Worker 註冊');
                    }
                } catch (error) {
                    log(`Service Worker 註銷失敗: ${error.message}`);
                }
            }
        }

        // 系統信息
        function refreshSystemInfo() {
            log('💻 刷新系統信息...');
            
            const info = document.getElementById('system-info');
            
            info.innerHTML = `
                <div class="metric">
                    <div class="metric-value">${navigator.userAgent.includes('Chrome') ? 'Chrome' : 
                                                navigator.userAgent.includes('Firefox') ? 'Firefox' : 
                                                navigator.userAgent.includes('Safari') ? 'Safari' : '其他'}</div>
                    <div class="metric-label">瀏覽器</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${window.location.protocol}</div>
                    <div class="metric-label">協議</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${navigator.onLine ? '在線' : '離線'}</div>
                    <div class="metric-label">網絡狀態</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${window.innerWidth}x${window.innerHeight}</div>
                    <div class="metric-label">視窗大小</div>
                </div>
                <p><strong>用戶代理:</strong> ${navigator.userAgent}</p>
                <p><strong>語言:</strong> ${navigator.language}</p>
                <p><strong>平台:</strong> ${navigator.platform}</p>
                <p><strong>Cookie 啟用:</strong> ${navigator.cookieEnabled ? '是' : '否'}</p>
                <p><strong>本地存儲:</strong> ${typeof(Storage) !== "undefined" ? '支援' : '不支援'}</p>
            `;
            
            log('系統信息已刷新');
        }

        // 頁面載入時初始化
        window.addEventListener('load', function() {
            log('🚀 部署修復測試工具已載入');
            
            // 初始化所有測試
            testVersionDetection();
            testCacheStatus();
            checkPWAStatus();
            testServiceWorker();
            refreshSystemInfo();
            
            log('所有初始測試已完成');
        });

        // 監聽 PWA 事件
        window.addEventListener('pwaInstallAvailable', function(event) {
            log('📱 收到 PWA 安裝可用事件: ' + JSON.stringify(event.detail));
        });

        window.addEventListener('pwaInstallAccepted', function() {
            log('✅ PWA 安裝被接受');
        });

        window.addEventListener('pwaInstalled', function() {
            log('🎉 PWA 安裝完成');
        });

        // 監聽版本更新事件
        window.addEventListener('beforeunload', function() {
            log('📄 頁面即將卸載');
        });
    </script>
</body>
</html> 