<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA 安裝功能測試</title>
    <link rel="manifest" href="/manifest.json?lang=zh-TW" id="manifest-link" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        .status-card {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 16px;
            border-left: 4px solid #3b82f6;
        }
        .status-card.success {
            border-left-color: #10b981;
            background: #ecfdf5;
        }
        .status-card.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        .status-card.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 8px 8px 0;
            transition: background 0.2s;
        }
        .button:hover {
            background: #2563eb;
        }
        .button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .button.secondary {
            background: #6b7280;
        }
        .button.secondary:hover {
            background: #4b5563;
        }
        .button.success {
            background: #10b981;
        }
        .button.success:hover {
            background: #059669;
        }
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin: 2px;
        }
        .badge.success {
            background: #dcfce7;
            color: #166534;
        }
        .badge.warning {
            background: #fef3c7;
            color: #92400e;
        }
        .badge.info {
            background: #dbeafe;
            color: #1e40af;
        }
        .instructions {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .step {
            display: flex;
            align-items: flex-start;
            margin: 12px 0;
        }
        .step-number {
            background: #3b82f6;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 12px;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 PWA 安裝功能測試</h1>
        <p>這個頁面用來測試 PWA 的官方安裝提示功能。</p>
    </div>

    <div class="container">
        <h2>📊 當前狀態</h2>
        <div class="status-grid">
            <div class="status-card" id="install-status">
                <h3>安裝狀態</h3>
                <p id="install-status-text">檢測中...</p>
                <div id="install-badges"></div>
            </div>
            <div class="status-card" id="platform-status">
                <h3>平台資訊</h3>
                <p id="platform-text">檢測中...</p>
                <div id="platform-badges"></div>
            </div>
            <div class="status-card" id="browser-status">
                <h3>瀏覽器支援</h3>
                <p id="browser-text">檢測中...</p>
                <div id="browser-badges"></div>
            </div>
            <div class="status-card" id="manifest-status">
                <h3>Manifest 狀態</h3>
                <p id="manifest-text">檢測中...</p>
                <div id="manifest-badges"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>🎯 測試操作</h2>
        <div>
            <button class="button" id="trigger-install" disabled>
                觸發安裝提示
            </button>
            <button class="button secondary" id="check-install">
                檢查安裝狀態
            </button>
            <button class="button secondary" id="simulate-prompt">
                模擬安裝事件
            </button>
            <button class="button secondary" id="clear-storage">
                清除本地存儲
            </button>
        </div>
        
        <div class="instructions" id="install-instructions" style="display: none;">
            <h3>📱 安裝指引</h3>
            <div id="instruction-steps"></div>
        </div>
    </div>

    <div class="container">
        <h2>📝 事件日誌</h2>
        <button class="button secondary" onclick="clearLog()">清除日誌</button>
        <div class="log" id="event-log">等待事件...</div>
    </div>

    <div class="container">
        <h2>🔧 開發者工具</h2>
        <p>在開發者工具中執行以下命令來測試：</p>
        <div class="log">
// 手動觸發 beforeinstallprompt 事件
window.dispatchEvent(new Event('beforeinstallprompt'));

// 檢查 PWA 條件
console.log('Service Worker:', 'serviceWorker' in navigator);
console.log('Manifest:', document.querySelector('link[rel="manifest"]'));
console.log('HTTPS:', location.protocol === 'https:');
console.log('Display Mode:', window.matchMedia('(display-mode: standalone)').matches);

// 檢查安裝狀態
console.log('Standalone:', window.navigator.standalone);
console.log('Display Mode:', window.matchMedia('(display-mode: standalone)').matches);
        </div>
    </div>

    <script>
        let installPrompt = null;
        let logContainer = document.getElementById('event-log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`PWA Test: ${message}`);
        }

        function clearLog() {
            logContainer.textContent = '日誌已清除\n';
        }

        function updateStatus() {
            // 檢測安裝狀態
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                               window.navigator.standalone ||
                               document.referrer.includes('android-app://');
            
            const installStatusCard = document.getElementById('install-status');
            const installStatusText = document.getElementById('install-status-text');
            const installBadges = document.getElementById('install-badges');
            
            if (isStandalone) {
                installStatusCard.className = 'status-card success';
                installStatusText.textContent = '應用已安裝並在獨立模式下運行';
                installBadges.innerHTML = '<span class="badge success">已安裝</span><span class="badge success">獨立模式</span>';
            } else if (installPrompt) {
                installStatusCard.className = 'status-card warning';
                installStatusText.textContent = '可以安裝，安裝提示已準備就緒';
                installBadges.innerHTML = '<span class="badge warning">可安裝</span><span class="badge info">提示就緒</span>';
                document.getElementById('trigger-install').disabled = false;
            } else {
                installStatusCard.className = 'status-card';
                installStatusText.textContent = '等待瀏覽器觸發安裝提示';
                installBadges.innerHTML = '<span class="badge info">等待中</span>';
            }

            // 檢測平台
            const userAgent = navigator.userAgent.toLowerCase();
            const platformCard = document.getElementById('platform-status');
            const platformText = document.getElementById('platform-text');
            const platformBadges = document.getElementById('platform-badges');
            
            let platform = 'Unknown';
            let badges = '';
            
            if (userAgent.includes('android')) {
                platform = 'Android';
                badges = '<span class="badge success">Android</span><span class="badge success">支援 PWA</span>';
                platformCard.className = 'status-card success';
            } else if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
                platform = 'iOS';
                badges = '<span class="badge warning">iOS</span><span class="badge warning">需手動安裝</span>';
                platformCard.className = 'status-card warning';
            } else if (userAgent.includes('windows')) {
                platform = 'Windows';
                badges = '<span class="badge success">Windows</span><span class="badge success">支援 PWA</span>';
                platformCard.className = 'status-card success';
            } else if (userAgent.includes('mac')) {
                platform = 'macOS';
                badges = '<span class="badge info">macOS</span><span class="badge info">部分支援</span>';
                platformCard.className = 'status-card';
            }
            
            platformText.textContent = `檢測到平台: ${platform}`;
            platformBadges.innerHTML = badges;

            // 檢測瀏覽器支援
            const browserCard = document.getElementById('browser-status');
            const browserText = document.getElementById('browser-text');
            const browserBadges = document.getElementById('browser-badges');
            
            const hasServiceWorker = 'serviceWorker' in navigator;
            const hasManifest = !!document.querySelector('link[rel="manifest"]');
            const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
            
            let browserSupport = 'Unknown';
            let browserBadgeHtml = '';
            
            if (userAgent.includes('chrome')) {
                browserSupport = 'Chrome';
                browserBadgeHtml = '<span class="badge success">Chrome</span><span class="badge success">完全支援</span>';
                browserCard.className = 'status-card success';
            } else if (userAgent.includes('firefox')) {
                browserSupport = 'Firefox';
                browserBadgeHtml = '<span class="badge warning">Firefox</span><span class="badge warning">部分支援</span>';
                browserCard.className = 'status-card warning';
            } else if (userAgent.includes('safari')) {
                browserSupport = 'Safari';
                browserBadgeHtml = '<span class="badge warning">Safari</span><span class="badge warning">需手動安裝</span>';
                browserCard.className = 'status-card warning';
            } else if (userAgent.includes('edge')) {
                browserSupport = 'Edge';
                browserBadgeHtml = '<span class="badge success">Edge</span><span class="badge success">完全支援</span>';
                browserCard.className = 'status-card success';
            }
            
            browserText.textContent = `瀏覽器: ${browserSupport}`;
            browserBadges.innerHTML = browserBadgeHtml + 
                (hasServiceWorker ? '<span class="badge success">SW</span>' : '<span class="badge error">無SW</span>') +
                (hasManifest ? '<span class="badge success">Manifest</span>' : '<span class="badge error">無Manifest</span>') +
                (isHTTPS ? '<span class="badge success">HTTPS</span>' : '<span class="badge error">HTTP</span>');

            // Manifest 狀態
            const manifestCard = document.getElementById('manifest-status');
            const manifestText = document.getElementById('manifest-text');
            const manifestBadges = document.getElementById('manifest-badges');
            
            if (hasManifest) {
                manifestCard.className = 'status-card success';
                manifestText.textContent = 'Manifest 文件已載入';
                manifestBadges.innerHTML = '<span class="badge success">已載入</span><span class="badge info">多語言</span>';
            } else {
                manifestCard.className = 'status-card error';
                manifestText.textContent = 'Manifest 文件未找到';
                manifestBadges.innerHTML = '<span class="badge error">未載入</span>';
            }
        }

        function showInstallInstructions() {
            const instructionsDiv = document.getElementById('install-instructions');
            const stepsDiv = document.getElementById('instruction-steps');
            
            const userAgent = navigator.userAgent.toLowerCase();
            let steps = [];
            
            if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
                steps = [
                    '點擊分享按鈕 📤',
                    '選擇「加入主畫面」',
                    '點擊「新增」確認'
                ];
            } else if (userAgent.includes('android')) {
                steps = [
                    '點擊瀏覽器選單 ⋮',
                    '選擇「安裝應用」或「加到主畫面」',
                    '點擊「安裝」確認'
                ];
            } else {
                steps = [
                    '點擊地址欄右側的安裝圖標',
                    '或使用瀏覽器選單中的「安裝」選項',
                    '按照提示完成安裝'
                ];
            }
            
            stepsDiv.innerHTML = steps.map((step, index) => 
                `<div class="step">
                    <div class="step-number">${index + 1}</div>
                    <div>${step}</div>
                </div>`
            ).join('');
            
            instructionsDiv.style.display = 'block';
        }

        // 事件監聽器
        window.addEventListener('beforeinstallprompt', (e) => {
            log('beforeinstallprompt 事件觸發', 'success');
            e.preventDefault();
            installPrompt = e;
            updateStatus();
        });

        window.addEventListener('appinstalled', () => {
            log('應用安裝完成', 'success');
            installPrompt = null;
            updateStatus();
        });

        // 按鈕事件
        document.getElementById('trigger-install').addEventListener('click', async () => {
            if (!installPrompt) {
                log('沒有可用的安裝提示', 'error');
                return;
            }

            try {
                log('觸發安裝提示', 'info');
                await installPrompt.prompt();
                
                const choiceResult = await installPrompt.userChoice;
                log(`用戶選擇: ${choiceResult.outcome}`, choiceResult.outcome === 'accepted' ? 'success' : 'warning');
                
                installPrompt = null;
                updateStatus();
            } catch (error) {
                log(`安裝失敗: ${error.message}`, 'error');
            }
        });

        document.getElementById('check-install').addEventListener('click', () => {
            log('檢查安裝狀態', 'info');
            updateStatus();
        });

        document.getElementById('simulate-prompt').addEventListener('click', () => {
            log('模擬 beforeinstallprompt 事件', 'info');
            const event = new Event('beforeinstallprompt');
            event.preventDefault = () => {};
            event.prompt = async () => {
                log('模擬安裝提示', 'info');
                return Promise.resolve();
            };
            event.userChoice = Promise.resolve({ outcome: 'accepted', platform: 'web' });
            
            installPrompt = event;
            updateStatus();
            showInstallInstructions();
        });

        document.getElementById('clear-storage').addEventListener('click', () => {
            localStorage.clear();
            sessionStorage.clear();
            log('本地存儲已清除', 'info');
        });

        // 初始化
        log('PWA 安裝測試頁面載入完成', 'info');
        updateStatus();
        
        // 定期更新狀態
        setInterval(updateStatus, 5000);
    </script>
</body>
</html> 