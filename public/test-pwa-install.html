<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA å®‰è£åŠŸèƒ½æ¸¬è©¦</title>
    <link rel="manifest" href="/manifest.json?lang=zh-TW" id="manifest-link" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        .status-card {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 16px;
            border-left: 4px solid #3b82f6;
        }
        .status-card.success {
            border-left-color: #10b981;
            background: #ecfdf5;
        }
        .status-card.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        .status-card.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 8px 8px 0;
            transition: background 0.2s;
        }
        .button:hover {
            background: #2563eb;
        }
        .button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .button.secondary {
            background: #6b7280;
        }
        .button.secondary:hover {
            background: #4b5563;
        }
        .button.success {
            background: #10b981;
        }
        .button.success:hover {
            background: #059669;
        }
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin: 2px;
        }
        .badge.success {
            background: #dcfce7;
            color: #166534;
        }
        .badge.warning {
            background: #fef3c7;
            color: #92400e;
        }
        .badge.info {
            background: #dbeafe;
            color: #1e40af;
        }
        .instructions {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .step {
            display: flex;
            align-items: flex-start;
            margin: 12px 0;
        }
        .step-number {
            background: #3b82f6;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 12px;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ PWA å®‰è£åŠŸèƒ½æ¸¬è©¦</h1>
        <p>é€™å€‹é é¢ç”¨ä¾†æ¸¬è©¦ PWA çš„å®˜æ–¹å®‰è£æç¤ºåŠŸèƒ½ã€‚</p>
    </div>

    <div class="container">
        <h2>ğŸ“Š ç•¶å‰ç‹€æ…‹</h2>
        <div class="status-grid">
            <div class="status-card" id="install-status">
                <h3>å®‰è£ç‹€æ…‹</h3>
                <p id="install-status-text">æª¢æ¸¬ä¸­...</p>
                <div id="install-badges"></div>
            </div>
            <div class="status-card" id="platform-status">
                <h3>å¹³å°è³‡è¨Š</h3>
                <p id="platform-text">æª¢æ¸¬ä¸­...</p>
                <div id="platform-badges"></div>
            </div>
            <div class="status-card" id="browser-status">
                <h3>ç€è¦½å™¨æ”¯æ´</h3>
                <p id="browser-text">æª¢æ¸¬ä¸­...</p>
                <div id="browser-badges"></div>
            </div>
            <div class="status-card" id="manifest-status">
                <h3>Manifest ç‹€æ…‹</h3>
                <p id="manifest-text">æª¢æ¸¬ä¸­...</p>
                <div id="manifest-badges"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ¯ æ¸¬è©¦æ“ä½œ</h2>
        <div>
            <button class="button" id="trigger-install" disabled>
                è§¸ç™¼å®‰è£æç¤º
            </button>
            <button class="button secondary" id="check-install">
                æª¢æŸ¥å®‰è£ç‹€æ…‹
            </button>
            <button class="button secondary" id="simulate-prompt">
                æ¨¡æ“¬å®‰è£äº‹ä»¶
            </button>
            <button class="button secondary" id="clear-storage">
                æ¸…é™¤æœ¬åœ°å­˜å„²
            </button>
        </div>
        
        <div class="instructions" id="install-instructions" style="display: none;">
            <h3>ğŸ“± å®‰è£æŒ‡å¼•</h3>
            <div id="instruction-steps"></div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“ äº‹ä»¶æ—¥èªŒ</h2>
        <button class="button secondary" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
        <div class="log" id="event-log">ç­‰å¾…äº‹ä»¶...</div>
    </div>

    <div class="container">
        <h2>ğŸ”§ é–‹ç™¼è€…å·¥å…·</h2>
        <p>åœ¨é–‹ç™¼è€…å·¥å…·ä¸­åŸ·è¡Œä»¥ä¸‹å‘½ä»¤ä¾†æ¸¬è©¦ï¼š</p>
        <div class="log">
// æ‰‹å‹•è§¸ç™¼ beforeinstallprompt äº‹ä»¶
window.dispatchEvent(new Event('beforeinstallprompt'));

// æª¢æŸ¥ PWA æ¢ä»¶
console.log('Service Worker:', 'serviceWorker' in navigator);
console.log('Manifest:', document.querySelector('link[rel="manifest"]'));
console.log('HTTPS:', location.protocol === 'https:');
console.log('Display Mode:', window.matchMedia('(display-mode: standalone)').matches);

// æª¢æŸ¥å®‰è£ç‹€æ…‹
console.log('Standalone:', window.navigator.standalone);
console.log('Display Mode:', window.matchMedia('(display-mode: standalone)').matches);
        </div>
    </div>

    <script>
        let installPrompt = null;
        let logContainer = document.getElementById('event-log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`PWA Test: ${message}`);
        }

        function clearLog() {
            logContainer.textContent = 'æ—¥èªŒå·²æ¸…é™¤\n';
        }

        function updateStatus() {
            // æª¢æ¸¬å®‰è£ç‹€æ…‹
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                               window.navigator.standalone ||
                               document.referrer.includes('android-app://');
            
            const installStatusCard = document.getElementById('install-status');
            const installStatusText = document.getElementById('install-status-text');
            const installBadges = document.getElementById('install-badges');
            
            if (isStandalone) {
                installStatusCard.className = 'status-card success';
                installStatusText.textContent = 'æ‡‰ç”¨å·²å®‰è£ä¸¦åœ¨ç¨ç«‹æ¨¡å¼ä¸‹é‹è¡Œ';
                installBadges.innerHTML = '<span class="badge success">å·²å®‰è£</span><span class="badge success">ç¨ç«‹æ¨¡å¼</span>';
            } else if (installPrompt) {
                installStatusCard.className = 'status-card warning';
                installStatusText.textContent = 'å¯ä»¥å®‰è£ï¼Œå®‰è£æç¤ºå·²æº–å‚™å°±ç·’';
                installBadges.innerHTML = '<span class="badge warning">å¯å®‰è£</span><span class="badge info">æç¤ºå°±ç·’</span>';
                document.getElementById('trigger-install').disabled = false;
            } else {
                installStatusCard.className = 'status-card';
                installStatusText.textContent = 'ç­‰å¾…ç€è¦½å™¨è§¸ç™¼å®‰è£æç¤º';
                installBadges.innerHTML = '<span class="badge info">ç­‰å¾…ä¸­</span>';
            }

            // æª¢æ¸¬å¹³å°
            const userAgent = navigator.userAgent.toLowerCase();
            const platformCard = document.getElementById('platform-status');
            const platformText = document.getElementById('platform-text');
            const platformBadges = document.getElementById('platform-badges');
            
            let platform = 'Unknown';
            let badges = '';
            
            if (userAgent.includes('android')) {
                platform = 'Android';
                badges = '<span class="badge success">Android</span><span class="badge success">æ”¯æ´ PWA</span>';
                platformCard.className = 'status-card success';
            } else if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
                platform = 'iOS';
                badges = '<span class="badge warning">iOS</span><span class="badge warning">éœ€æ‰‹å‹•å®‰è£</span>';
                platformCard.className = 'status-card warning';
            } else if (userAgent.includes('windows')) {
                platform = 'Windows';
                badges = '<span class="badge success">Windows</span><span class="badge success">æ”¯æ´ PWA</span>';
                platformCard.className = 'status-card success';
            } else if (userAgent.includes('mac')) {
                platform = 'macOS';
                badges = '<span class="badge info">macOS</span><span class="badge info">éƒ¨åˆ†æ”¯æ´</span>';
                platformCard.className = 'status-card';
            }
            
            platformText.textContent = `æª¢æ¸¬åˆ°å¹³å°: ${platform}`;
            platformBadges.innerHTML = badges;

            // æª¢æ¸¬ç€è¦½å™¨æ”¯æ´
            const browserCard = document.getElementById('browser-status');
            const browserText = document.getElementById('browser-text');
            const browserBadges = document.getElementById('browser-badges');
            
            const hasServiceWorker = 'serviceWorker' in navigator;
            const hasManifest = !!document.querySelector('link[rel="manifest"]');
            const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
            
            let browserSupport = 'Unknown';
            let browserBadgeHtml = '';
            
            if (userAgent.includes('chrome')) {
                browserSupport = 'Chrome';
                browserBadgeHtml = '<span class="badge success">Chrome</span><span class="badge success">å®Œå…¨æ”¯æ´</span>';
                browserCard.className = 'status-card success';
            } else if (userAgent.includes('firefox')) {
                browserSupport = 'Firefox';
                browserBadgeHtml = '<span class="badge warning">Firefox</span><span class="badge warning">éƒ¨åˆ†æ”¯æ´</span>';
                browserCard.className = 'status-card warning';
            } else if (userAgent.includes('safari')) {
                browserSupport = 'Safari';
                browserBadgeHtml = '<span class="badge warning">Safari</span><span class="badge warning">éœ€æ‰‹å‹•å®‰è£</span>';
                browserCard.className = 'status-card warning';
            } else if (userAgent.includes('edge')) {
                browserSupport = 'Edge';
                browserBadgeHtml = '<span class="badge success">Edge</span><span class="badge success">å®Œå…¨æ”¯æ´</span>';
                browserCard.className = 'status-card success';
            }
            
            browserText.textContent = `ç€è¦½å™¨: ${browserSupport}`;
            browserBadges.innerHTML = browserBadgeHtml + 
                (hasServiceWorker ? '<span class="badge success">SW</span>' : '<span class="badge error">ç„¡SW</span>') +
                (hasManifest ? '<span class="badge success">Manifest</span>' : '<span class="badge error">ç„¡Manifest</span>') +
                (isHTTPS ? '<span class="badge success">HTTPS</span>' : '<span class="badge error">HTTP</span>');

            // Manifest ç‹€æ…‹
            const manifestCard = document.getElementById('manifest-status');
            const manifestText = document.getElementById('manifest-text');
            const manifestBadges = document.getElementById('manifest-badges');
            
            if (hasManifest) {
                manifestCard.className = 'status-card success';
                manifestText.textContent = 'Manifest æ–‡ä»¶å·²è¼‰å…¥';
                manifestBadges.innerHTML = '<span class="badge success">å·²è¼‰å…¥</span><span class="badge info">å¤šèªè¨€</span>';
            } else {
                manifestCard.className = 'status-card error';
                manifestText.textContent = 'Manifest æ–‡ä»¶æœªæ‰¾åˆ°';
                manifestBadges.innerHTML = '<span class="badge error">æœªè¼‰å…¥</span>';
            }
        }

        function showInstallInstructions() {
            const instructionsDiv = document.getElementById('install-instructions');
            const stepsDiv = document.getElementById('instruction-steps');
            
            const userAgent = navigator.userAgent.toLowerCase();
            let steps = [];
            
            if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
                steps = [
                    'é»æ“Šåˆ†äº«æŒ‰éˆ• ğŸ“¤',
                    'é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€',
                    'é»æ“Šã€Œæ–°å¢ã€ç¢ºèª'
                ];
            } else if (userAgent.includes('android')) {
                steps = [
                    'é»æ“Šç€è¦½å™¨é¸å–® â‹®',
                    'é¸æ“‡ã€Œå®‰è£æ‡‰ç”¨ã€æˆ–ã€ŒåŠ åˆ°ä¸»ç•«é¢ã€',
                    'é»æ“Šã€Œå®‰è£ã€ç¢ºèª'
                ];
            } else {
                steps = [
                    'é»æ“Šåœ°å€æ¬„å³å´çš„å®‰è£åœ–æ¨™',
                    'æˆ–ä½¿ç”¨ç€è¦½å™¨é¸å–®ä¸­çš„ã€Œå®‰è£ã€é¸é …',
                    'æŒ‰ç…§æç¤ºå®Œæˆå®‰è£'
                ];
            }
            
            stepsDiv.innerHTML = steps.map((step, index) => 
                `<div class="step">
                    <div class="step-number">${index + 1}</div>
                    <div>${step}</div>
                </div>`
            ).join('');
            
            instructionsDiv.style.display = 'block';
        }

        // äº‹ä»¶ç›£è½å™¨
        window.addEventListener('beforeinstallprompt', (e) => {
            log('beforeinstallprompt äº‹ä»¶è§¸ç™¼', 'success');
            e.preventDefault();
            installPrompt = e;
            updateStatus();
        });

        window.addEventListener('appinstalled', () => {
            log('æ‡‰ç”¨å®‰è£å®Œæˆ', 'success');
            installPrompt = null;
            updateStatus();
        });

        // æŒ‰éˆ•äº‹ä»¶
        document.getElementById('trigger-install').addEventListener('click', async () => {
            if (!installPrompt) {
                log('æ²’æœ‰å¯ç”¨çš„å®‰è£æç¤º', 'error');
                return;
            }

            try {
                log('è§¸ç™¼å®‰è£æç¤º', 'info');
                await installPrompt.prompt();
                
                const choiceResult = await installPrompt.userChoice;
                log(`ç”¨æˆ¶é¸æ“‡: ${choiceResult.outcome}`, choiceResult.outcome === 'accepted' ? 'success' : 'warning');
                
                installPrompt = null;
                updateStatus();
            } catch (error) {
                log(`å®‰è£å¤±æ•—: ${error.message}`, 'error');
            }
        });

        document.getElementById('check-install').addEventListener('click', () => {
            log('æª¢æŸ¥å®‰è£ç‹€æ…‹', 'info');
            updateStatus();
        });

        document.getElementById('simulate-prompt').addEventListener('click', () => {
            log('æ¨¡æ“¬ beforeinstallprompt äº‹ä»¶', 'info');
            const event = new Event('beforeinstallprompt');
            event.preventDefault = () => {};
            event.prompt = async () => {
                log('æ¨¡æ“¬å®‰è£æç¤º', 'info');
                return Promise.resolve();
            };
            event.userChoice = Promise.resolve({ outcome: 'accepted', platform: 'web' });
            
            installPrompt = event;
            updateStatus();
            showInstallInstructions();
        });

        document.getElementById('clear-storage').addEventListener('click', () => {
            localStorage.clear();
            sessionStorage.clear();
            log('æœ¬åœ°å­˜å„²å·²æ¸…é™¤', 'info');
        });

        // åˆå§‹åŒ–
        log('PWA å®‰è£æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ', 'info');
        updateStatus();
        
        // å®šæœŸæ›´æ–°ç‹€æ…‹
        setInterval(updateStatus, 5000);
    </script>
</body>
</html> 